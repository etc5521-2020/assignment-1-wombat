---
title: "ETC5521_Assignment1_wombat"
author: "Hanh Ngo, Dewi Lestari Amaliah"
date: "8/14/2020"
bibliography: references.bib
output: 
  bookdown::html_document2:
    citation_package: biblatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
library(visdat)
library(skimr)
library(plotly)
library(gridExtra)
```

# Introduction


# Data description

```{r load-data}
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')
```


## Source of data


## Detail Structure of the data


## Time frame of collection

The time frame covered in this data set is from 1st July of 2015 to 31st August of 2017, daily. 


## Collection Method

@AntonioNuno2019Hbdd collected the data by extracting the variables from the hotels' PMS databases' server with a TSQL query in SQL Server Studio Manager. The tables that were used to extract the variables are: 

1. BO (booking table in which the key, which is the ID, was retrieved).
2. BL (bookings change log, in this case, if the booking details with respect to the day before arrival changed, the value used was the one present in this table).
3. ML (meals).
4. DC (distribution channel).
5. TR (transaction).
6. CP (customer profiles).
7. NT (nationalities).
8. MS (market segments). 

Regarding the time stamp, when the bookings were created before the arrival, the values were retrieved on the day prior to the arrival date.

# Limitations:


# Data cleaning


## Missing values checking


@BennettDerrickA argued that it is important to take missing value into account, otherwise the statistical analysis will be misleading and variability of the data could not be estimated correctly. Thus, before analyzing the data, we checked the missing value using `visdat` package [@visdat] first. 


```{r missing-vals-check, cache = TRUE, fig.cap= "Variables Type and Missing Value Visualization"}

vis_dat(hotels, warn_large_data = FALSE)

```

Figure \@ref(fig:missing-vals-check) shows that there is no missing value in the dataset. It is inline with what @AntonioNuno2019Hbdd stated that there is no missing values in the database table. However, some "NULL" values were presented which should be interpreted as "not applicable", not a missing value [@AntonioNuno2019Hbdd]. For example, if the the **company** value is NULL, it means that the booking was not made by a company.  


## Data type checking


Figure \@ref(fig:missing-vals-check) also conveys the type of the variables in the dataset. We could see that a lot of variables (such as *hotel*, *distribution_channel*, and *is_cancelled*) have incorrect type. Those variables should be a factor/categorical instead of a character or numeric variables. Therefore, the type of the data should be corrected before doing the analysis. 

```{r}
hotels_corrected_type <- hotels %>%
  mutate(hotel = as.factor(hotel),
         is_canceled = as.factor(is_canceled),
         arrival_date_month = as.factor(arrival_date_month),
         arrival_date_year = as.factor(arrival_date_year),
         meal = as.factor(meal),
         country = as.factor(country),
         market_segment = as.factor(market_segment),
         distribution_channel = as.factor(distribution_channel),
         is_repeated_guest = as.factor(is_repeated_guest),
         reserved_room_type = as.factor(reserved_room_type),
         assigned_room_type = as.factor(assigned_room_type),
         deposit_type = as.factor(deposit_type),
         agent = as.factor(agent),
         company = as.factor(company),
         customer_type = as.factor(customer_type),
         reservation_status = as.factor(reservation_status))
```


```{r data-type, cache = TRUE, fig.cap= "Data Type Visualization"}
vis_dat(hotels_corrected_type, warn_large_data = FALSE)
```
Figure \@ref(fig:data-type) portrays that the variables have been in a correct type.


# Analysis


## Exploration of Market Segment

```{r market-segment-change}

ms_change <- ggplot(hotels_corrected_type) +
  geom_bar(aes(x = arrival_date_year, 
               fill = market_segment), 
           position = "fill") +
  facet_wrap(~hotel)

ggplotly(ms_change)



```


We need to know the distribution the ADR 


from Online TA since most of the booking from this market segment compared to other major market segment. However, in order to examine how the Online TA bookings have contributed to the hotel's revenue, we would only use the data from the actual booking (the not canceled bookings). Besides, we would use the data from 2017 only, since the Online TAs have taken majority of bookings in both hotel in this year.

```{r is_canceled_ms}
ggplot(filter(hotels_corrected_type, arrival_date_year == 2017)) +
  geom_bar(aes(x = hotel,
               fill = is_canceled),
           position = "fill") +
  facet_wrap(~market_segment)
```


From graph above, we could see that despite the high number of booking from Online TA, the cancellation rate from this market segment is also high compared to the other market, except for the group bookings especially in city hotel. Hence, we should examine the distribution of hotel guests from the actual booking only. 


```{r actual_guest}
actual_guest <- hotels_corrected_type %>%
  filter(is_canceled == 0)
```

```{r actual_guest_ms}
ggplot(filter(actual_guest, arrival_date_year == 2017)) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill")
```

Meal distribution

```{r meal-dist}
ggplot(filter(actual_guest, arrival_date_year == 2017)) +
  geom_bar(aes(x = hotel,
               fill = meal),
           position = "fill")
```
```{r adr-pp-cal}
actual_guest <- actual_guest %>%
  mutate(adr_pp = adr / (adults + children + babies))
```


```{r adr-ms}

ggplot(filter(actual_guest, arrival_date_year == 2017 & meal == "BB" & adr != 0)) +
  geom_boxplot(aes(x = market_segment,
               y = adr, fill = market_segment)) +
  facet_grid(hotel ~ assigned_room_type) +
  theme(legend.position = "bottom",
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank())
```






