---
title: "ETC5521_Assignment1_wombat"
author: "Hanh Ngo, Dewi Lestari Amaliah"
date: "8/14/2020"
bibliography: references.bib
output: 
  bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
library(visdat)
library(skimr)
library(plotly)
library(gridExtra)
library(countrycode)
library(DT)
library(maps)
library(viridis)
library(viridisLite)
```

# Introduction


# Data description

```{r load-data, cache = TRUE}
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')
```


## Source of data


## Detail Structure of the data


## Time frame of collection

The time frame covered in this data set is from 1st July of 2015 to 31st August of 2017, daily. 


## Collection Method

@AntonioNuno2019Hbdd collected the data by extracting the variables from the hotels' PMS databases' server with a TSQL query in SQL Server Studio Manager. The tables that were used to extract the variables are: 

1. BO (booking table in which the key, which is the ID, was retrieved).
2. BL (bookings change log, in this case, if the booking details with respect to the day before arrival changed, the value used was the one present in this table).
3. ML (meals).
4. DC (distribution channel).
5. TR (transaction).
6. CP (customer profiles).
7. NT (nationalities).
8. MS (market segments). 

Regarding the time stamp, when the bookings were created before the arrival, the values were retrieved on the day prior to the arrival date.

## Limitation of Data


- Since the observation began in July 2015 and ended in August 2017, we only have a fully cover data by year in 2016. Moreover, the coverage of the dataset in 2015 and 2017 are only six months and eight months, respectively. Hence, we would not analyze the data in year-wise manner because it might be not apple to apple. 


## Data cleaning


### Missing values checking


@BennettDerrickA argued that it is important to take missing value into account, otherwise the statistical analysis will be misleading and variability of the data could not be estimated correctly. Thus, before analyzing the data, we checked the missing value using `visdat` package [@visdat] first. 

<center>

```{r missing-vals-check, cache = TRUE, fig.cap= "Variables Type and Missing Value Visualization"}

vis_dat(hotels, warn_large_data = FALSE)

```

</center>


Figure \@ref(fig:missing-vals-check) shows that there is no missing value in the dataset. It is inline with what @AntonioNuno2019Hbdd stated that there is no missing values in the database table. However, some "NULL" values were presented which should be interpreted as "not applicable", not a missing value [@AntonioNuno2019Hbdd]. For example, if the the **company** value is NULL, it means that the booking was not made by a company.  


### Data type checking


Figure \@ref(fig:missing-vals-check) also conveys the type of the variables in the dataset. We could see that a lot of variables (such as *hotel*, *distribution_channel*, and *is_canceled*) have incorrect type. Those variables should be a factor/categorical instead of a character or numeric variables. Therefore, the type of the data should be corrected before doing the analysis. 

```{r}
hotels_corrected_type <- hotels %>%
  mutate(hotel = as.factor(hotel),
         is_canceled = as.factor(is_canceled),
         arrival_date_month = as.factor(arrival_date_month),
         arrival_date_year = as.factor(arrival_date_year),
         meal = as.factor(meal),
         country = as.factor(country),
         market_segment = as.factor(market_segment),
         distribution_channel = as.factor(distribution_channel),
         is_repeated_guest = as.factor(is_repeated_guest),
         reserved_room_type = as.factor(reserved_room_type),
         assigned_room_type = as.factor(assigned_room_type),
         deposit_type = as.factor(deposit_type),
         agent = as.factor(agent),
         company = as.factor(company),
         customer_type = as.factor(customer_type),
         reservation_status = as.factor(reservation_status))
```



<center>

```{r data-type, cache = TRUE, fig.cap= "Data Type Visualization"}
vis_dat(hotels_corrected_type, warn_large_data = FALSE)
```
</center>



Figure \@ref(fig:data-type) portrays that the variables have been in a correct type.




# Analysis


## Exploring the Hotels' Market Segment


According to @meier, a relevant market segment is one of the key to be successful in hotel management, especially to set the price correctly. Therefore, it is essential to define the distribution of these hotels market segment. 

Figure \@ref(fig:market-segment-change) shows that the city hotel received more booking compared to the resort hotel. It also conveys that the vast majority of bookings in both hotel were made through Online Travel Agent (OTA). However, the portion of bookings through OTA was bigger in the city hotel than in the resort hotel. In contrast to the city hotel, we could see more portion of direct bookings in the resort hotel than group bookings.

A study from [Phocuswright](https://www.pegs.com/blog/why-do-travelers-prefer-booking-with-otas/) in @pegs stated that one of the major reason of why do the people book trough OTA is beacuse the website is easy to use. Meanwhile, @howe argued that OTAs are favorable because its easy booking option. According to @jedina2017exploring in @TalwarShalini2020Wdpp, the factors for booking the hotel through OTA are the accessibility, pricing, review accountability, and the customer services. 


<center>


```{r market-segment-change, fig.cap = "The distribution of hotel market segment in the city and resort hotel (2015-2017)"}

ms_change <- ggplot(hotels_corrected_type) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8))

ggplotly(ms_change)

```
</center>


To gain more insight from the market segment, in this case to examine how much the OTA bookings would have contributed to hotels' revenue, we need to know the distribution the ADR from each market segment. However, we would only use the data from the actual guests, which is the guests who did not cancel the booking, since only this kind of bookings that would bring the actual revenue for the hotels. 


```{r}
hotels_corrected_type <- hotels_corrected_type %>%
  mutate(is_canceled_new = if_else(
           condition = is_canceled == 0,
           true = "not canceled",
           false = "canceled"),
         length_of_stay = stays_in_weekend_nights + stays_in_week_nights,
         stay_on = ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights != 0, "Weekday and Weekend",
                          ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights == 0, "Weekend", "Weekday")),
         )
```


<center>

```{r is-canceled-ms, fig.cap = "Cancellation rate by market segment"}

is_canceled_ms <- ggplot(hotels_corrected_type) +
  geom_bar(aes(x = hotel,
               fill = is_canceled_new),
           position = "fill") +
  facet_wrap(~market_segment) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        text = element_text(size = 8)) +
  ylab("Proportion") +
  xlab("Hotel")

ggplotly(is_canceled_ms)

```

</center>

From Figure \@ref(fig:is-canceled-ms), we could see that despite the high number of booking from Online TA, the cancellation rate from this market segment was also high (more than 30 percent in both hotels). In addition, the cancellation rate in the city hotel was higher than in the resort hotel in the vast majority of market segments. In the group bookings, the cancellation rate even almost reached 70 percent of all bookings. Hence, we should examine the distribution of hotel guests from the actual booking only. Figure \@ref(fig:is-canceled-ms) also suggests that the hotel management should apply a more strict cancellation policy given the high number of canceled bookings. 


```{r actual_guest}
actual_guest <- hotels_corrected_type %>%
  filter(is_canceled == 0)
```


<center>

```{r actual-guest-ms, fig.cap= "The distribution of hotels' actual guest by market segment"}

actual_guest_ms <- ggplot(actual_guest) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  theme(legend.title = element_blank(),
        text = element_text(size = 8)) +
  ylab("Proportion") +
  xlab("Hotel")

ggplotly(actual_guest_ms)
```

</center>


Figure \@ref(fig:actual-guest-ms) conveys that most of guests in both hotels made the bookings through OTA, eventhough the cancellation rate from this market segment was also high. The reason might be because the portion was already big and the other categories also made cancellations. Since *complementary*, *aviation*, and *corporate* categories share fewer proportion of bookings compared to the others, we would recode these categories into *other* category.


```{r recode}
actual_guest <- actual_guest %>%
  mutate(market_segment_new = case_when(
    str_detect(market_segment, "Aviation") ~ "Other",
    str_detect(market_segment, "Corporate") ~ "Other",
    str_detect(market_segment, "Complementary") ~ "Other",
    str_detect(market_segment, "Direct") ~ "Direct",
    str_detect(market_segment, "Groups") ~ "Groups",
    str_detect(market_segment, "Offline TA/TO") ~ "Offline TA/TO",
    str_detect(market_segment, "Online TA") ~ "Online TA"))


#check if there is a miss recode
#filter(actual_guest, is.na(market_segment_new))
```


In the dataset, we do not have any information about the ADR by the room type and by the meal. In fact, these to variables would determine the booking rate. Therefore, in order to get unbiased insight, we would analyze the ADR only in the most booking meal. Figure \@ref(fig:meal-dist) suggests that the most booked meal category is the Bed and Breakfast (BB). 

<center>

```{r meal-dist, fig.cap= "The distribution of hotel bookings by meal"}

meal_dist <- ggplot(actual_guest) +
  geom_bar(aes(x = hotel,
               fill = meal),
           position = "fill") +
  xlab("Hotel") +
  ylab("Proportion") +
  theme(text = element_text(size = 8))

ggplotly(meal_dist)
  
```
</center>



```{r adr-null}

adr_null <- filter(actual_guest, adr == 0)

p_adr_null <- round(nrow(adr_null)/nrow(actual_guest)*100, 2)

```

<br>

There is no information of the currency used in the ADR variable. Thus, we assumed that the ADR is stated in Euro since these hotels are located in Portugal. In this variable, we also found 0 value (`r p_adr_null` percent of the data), but we did not find any further information about it. We assumed that it could be the free stay vouchers which are given to the guests. We would not include this observations in the analysis because it would not contribute to the hotels' revenue.  

Figure \@ref(fig:adr-ms) shows that the distribution of ADR based on the market segment across room type is heterogeneous.  We could also found many outlier observations. Figure \@ref(fig:adr-ms) also suggests that in the city hotel, the bookings from OTA were found to have the highest median of ADR in the A, B, D, F, G rooms (5 out of 8 room types). Direct category had the highest median of ADR in three room types, namely C, E and K. In the resort hotel, the bookings from OTA also had the highest median of ADR in 6 out of 9 types of room (A, B, D, E, G, I). In addition, the highest ADR median in the other room types were made through direct booking. This finding indicates that it might be that hotel management has used the insight from the market segment to manage the price of the room to gain more revenue. 


<center>

```{r adr-ms, fig.width = 10, fig.height=7, fig.cap = "The distibution of ADR by assigned room type with BB meal in the city and resort hotel"}

adr_ms <- ggplot(filter(actual_guest, meal == "BB" & adr != 0)) +
  geom_boxplot(aes(x = market_segment_new,
               y = adr, fill = market_segment_new)) +
  facet_grid(hotel ~ assigned_room_type) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_blank(),
        text = element_text(size = 8)) +
  ylab("ADR (Euro)")+
  xlab("Market Segment")


#centering the legend position
ggplotly(adr_ms) %>%
  layout(legend = list(orientation = "h",
                       x = 0.2, y = -0.1))
  
```

</center>




This finding is also in line with the result of the consumer research from [Which?](https://www.theguardian.com/money/2020/mar/04/travellers-may-lose-out-by-booking-hotels-online-says-which) in @hern which stated that the travelers are paying up more for the hotel room through online booking. From this finding, we could also learn that from the customer perspective, it is might be better to book the hotel through group booking or offline travel agent because they were cheaper.


From this exploration, we could tell that the online travel agent has dominated the market segment both in the city and resort hotels. In addition, since the median of OTA ADR is the highest in most room types for the same type of meal, we could infer that the OTA bookings had been being a valuable resource of revenue for both hotels.  

<br>
<br>

## Where Did The Bookings Come From?
<br>

Another way to gain more insight about the market is to examine the origin of the travelers that book the hotel room. It is important to understand their behavior and preference. Hence, the businesses are able to develop strategies to attract them. 

```{r country-check}

# check if there is undefined country in the hotel bookings

#dplyr::distinct(hotels_corrected_type, country)

# Apparently, there is also a null observation in the country name. 
# We would like to know the percentage of this null country observation.

null_country <- hotels_corrected_type %>% filter(country == "NULL")
p_null_country <- round(nrow(null_country)/ nrow(hotels_corrected_type) * 100, 3)


```

Firstly, we would like to observe the distribution of the country of the origin of the bookings in both hotel. This dataset indeed does not have any missing value, but it has a NULL value, which means that we can not gain any insight from these observations. Thus, before doing the analysis, we check for the NULL value in the country variable first. We found that `r p_null_country` percent of observations have a NULL value in their country variable. In this case we omitted these observations because the number of observations is large enough and the proportion of NULL cases is relatively small [@KangHyun2013Tpah].

```{r bookers-table}

book_origin <- hotels_corrected_type %>% filter(country != "NULL") %>% 
  group_by(country) %>%
  count(country) %>%
  arrange(desc(n)) %>%
  ungroup

# The country comes in ISO3 name, in order to get better interpretation, we recode the country to its actual name

country_name <- countrycode(book_origin$country, "iso3c", "country.name")

book_origin_new <- cbind(book_origin, country_name)

#countrycode function could not find the match of "CN" and "TMP", so we changed it manually

book_origin_new[13,3] = "CN"
book_origin_new[130,3] = "East Timor"

col_order <- c("country", "country_name", "n")

book_origin_table <-  book_origin_new[, col_order]

```


Figure \@ref(fig:bookings-map) provided the map of the bookings origin country to get a better view of the distribution of the bookings. 

<center>

```{r bookings-map, fig.cap = "The distibution of travelers origin who books the hotels in 2015-2017"}

world_map <- map_data("world")
bookings_map_dat <- left_join(book_origin_table, world_map, by = c("country_name" = "region"))

bookings_map <- ggplot(bookings_map_dat, aes(long, lat, group = group))+
  geom_polygon(aes(fill = n ), color = "white") +
  scale_fill_viridis("C")+
  theme_bw()

ggplotly(bookings_map)

```

</center> 

If we hover to the map, we found that the bookings came from most of the country across the world. In order to get a detail view, we provided the table of the bookings country of origin. The table suggests that the bookings came from `r nrow(book_origin_table)` different countries. 

<br>

```{r origin_table}
DT::datatable(book_origin_table, colnames = c("Country Code", "Country Name", "Number of Bookings"),
              caption = "The number of hotel bookings based on bookings country of origin")
```

<br>


The country fact conveys that by country-wise, most bookings were from Portugal. However the number of bookings made by international traveler are also a lot, especially from the European countries. In the further analysis, we would categorize the bookings into two categories: "local" and "international".  

```{r mutate-origin}

# Create new variable which categorize the origin of travelers.
# We omitted the country observations that are equal to NULL

origin_cat <- hotels_corrected_type %>%
  filter(country != "NULL") %>%
  mutate(origin = if_else(
           condition = country == "PRT",
           true = "local",
           false = "international"))
```



<center>

```{r origin-plot, fig.cap = "Bookings in city and resort hotel by country of origin"}

origin_plot <- ggplot(origin_cat) +
  geom_bar(aes(x = hotel, 
               fill = origin), 
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8))

ggplotly(origin_plot)

```

</center>

<br>

Figure \@ref(fig:origin-plot) portrays that the international booking was dominating in both hotels. Somehow, the portion pattern is quite similar to the pattern of the bookings that made by OTA in the Figure \@ref(fig:market-segment-change). Therefore it is interesting to examine the market segment of the international bookings. 

<center>

```{r origin-ms, fig.cap = "Distribution of international travelers by market segment"}

origin_ms <- ggplot(filter(origin_cat, origin == "international")) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  xlab("Hotel") +
  ylab("Proportion") +
  theme(text = element_text(size = 8))

ggplotly(origin_ms)


```

</center>

<br>

According to Figure \@ref(fig:origin-ms), vast majority of international bookings were made through OTA in both hotels. This fact, once again, proved the OTA dominance in the hospitality industry. One interesting fact is that in the resort hotel, many international travelers also booked through offline TA/TO. 

We were curious whether the international travelers pay more than the local travelers. It is actually interesting question since most of bookings came from abroad. To answer this question we would only, again, using the data from actual bookings. In addition, to avoid bias in the interpretation, we would only use the observations from the same room type and meal category. According to Figure \@ref(fig:meal-room-dist), we would use the observations with "BB" meal booking and from room type "A" due to the huge portion of these categories in both hotels.

<center>

```{r meal-room-dist, fig.cap = "Meal and moom type distribution of hotels' guests", fig.width=10}

meal_dist_origin <- ggplot(filter(origin_cat, is_canceled == 0)) +
  geom_bar(aes(x = hotel,
               fill = meal),
           position = "fill") +
  xlab("Hotel") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  ggtitle("Meal distribution")


room_dist_origin <- ggplot(filter(origin_cat, is_canceled == 0)) +
  geom_bar(aes(x = hotel,
               fill = assigned_room_type),
           position = "fill") +
  xlab("") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  ggtitle("Room type distribution")



grid.arrange(meal_dist_origin, room_dist_origin, ncol = 2)

```

</center>

<br>


<center>

```{r adr-origin-boxplot, fig.cap="Distribution of ADR by guest origin in the city and resort hotel"}

adr_origin <- filter(origin_cat, is_canceled == 0 & meal == "BB" & assigned_room_type == "A")
ggplot(adr_origin) +
  geom_boxplot(aes(x = origin,
               y = adr, fill = origin)) +
  facet_wrap(~ hotel)
```
</center>


In Figure \@ref(fig:origin-plot), we found the fact that most bookings in both hotels are from international travelers and Figure \@ref(fig:adr-origin-boxplot) shows that they paid relatively more money than the locals in both types of the hotel. However, did they actually have a preference regarding the type of the hotel they want to stay at?



<center>

```{r origin-cat-hotel, fig.cap = "The number of bookings by hotel type"}

origin_cat_hotel <- ggplot(filter(origin_cat, origin == "international" & is_canceled == 0)) +
  geom_bar(aes(x = hotel, 
               fill = hotel), 
           position = "dodge")

ggplotly(origin_cat_hotel)

```


</center>

Figure \@ref(fig:origin-cat-hotel) conveys that more international travelers chose to stay at the city hotel. It is definitely not because of the price since Figure \@ref(fig:adr-origin-boxplot) shows that the ADR of city hotel was higher than resort hotel. We wondered that may be these international travelers were business travelers or not. 

According to 
Hence, we would try to figure out the answer by looking at the distribution of the length and the time of stay. 

We found that some observations have 0 in the `stay_weekday_nights` and the `stay_weekend_nights` variables. Hence, we would omit these observations from analysis. 

```{r}

ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0)) +
  geom_boxplot(aes(y = length_of_stay, x = hotel))

```

```{r}

ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0)) +
  geom_bar(aes(x = hotel,
               fill = stay_on),
           position = "fill")

```


## Family Matters

```{r}

```



# Conclusion

# References
