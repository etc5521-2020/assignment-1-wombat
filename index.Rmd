---
title: "ETC5521 Assignment 1"
subtitle: "Your title"
team: WOMBAT
author:
  - Hai Hanh Ngo
  - Dewi Lestari Amaliah
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(gridExtra)
```

# Introduction and motivation

[FILL] Give the bigger picture of the data, and inspire the reader to learn more about the problem by reading your analysis. 

# Data description

In 2018, Nuno Antonio, Ana de Almeida and Luis Nunes published a data article called "Hotel booking demand datasets" which introduced to the public two datasets for two hotels in Portugal, one resort in Algarve (H1) and one city hotel in Lisbon (H2). These datasets were originally collected to serve the development of prediction models to assess the hotels' likelihood of having their bookings cancelled, however the uses of variables included also allow other researching purposes. 

The datasets for the two hotels can be downloaded separately at https://www.sciencedirect.com/science/article/pii/S2352340918315191. However, *jthomasmock* at _tidytuesday challenge_ had done us a favor and combined the two datasets into one. The two original datasets and the combined one can be obtained at https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md. 

The dataset is stored in a _csv_ file format with 32 variables and 119,390 observations (40,060 for H1 and 79,330 for H2). Each observation represents one hotel booking. The format of the dataset is as below:

```{r load-data}
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')
```

```{r glimpse}
glimpse(hotels)
```

Knowing this dataset belonged to a hotel, we can make sense most of the variables. However, not all of them are familiar for anyone who did not have a background of hotel management. We will run through some of the industry jargons and variables'meaning before we take a further look at the data.

Variables note:  
- is_cancelled: (1) if the booking was cancelled and (0) if not.  
- lead_time: number of days between when the booking was entered into the hotel's booking system and the arrival date.  
- meal:  Type of meal booked which can be:  
  * BB: Bed and Breakfast.  
  * FB: Full board (breakfast, lunch and dinner).  
  * HB: Half board (breakfast and one meal, usually dinner).  
  * Undefined/ SC: no meal package.  
- country:  Guests'country of origin.  
- market_segment: guests'market segment, some of which may associate with booking channel.    
  * Direct: guests that make bookings directly with the hotels, could be from hotel's website/ phone booking or walk-ins.  
  * Corporate: Guests whom bookings are made by corporate/ company or guests who are business travellers.    
  * Online TA: Online travel agents - bookings that made through a third party websites. Examples are Agoda, Expedia, Booking.com...  
  * Offline TA/TO: Bookings made by Travel agents or Tour operators.  
  * Complementary: Free stays offered for guests, usually from hotels' promotional programs.    
  * Groups: guests who travelled in groups.  
  * Undefined: Undefined type of guests.  
  * Aviation: We are not entirely sure but this could be airline crews.    
- Distribution_channel:   
  * Direct: bookings that made directly with the hotels (hotel's websites, phone or walk-ins)  
  * Corporate:  bookings made by corporate/company.
  * TA/TO: Travel agents/ tour operators/    
  * Undefined: Undefined distribution channel.  
  * GDS: Global Distribution System. GDS served like a hub for companies in the travel industry (airlines, hotels, car rental...) to connect with travel agents. Hotels will put some of their inventories (rooms) to the GDS and travel agents then can sell those rooms to their customers. Some of the well-known GDS include Amadeus, Sabre and Galileo.   
- is_repeated_guess: (1) if repeated and (0) if not.   
- customer_type:    
  * Transient: Individuals or groups that occupy less than 10 rooms per night. These guests usually stay in the hotel short - term and require little services.  
  * Contract: bookings bound by contracts, usually for more than 30 days for a consistent block of rooms.  
  * Transient - Party: Transient booking but associated to other transient booking.   
  * Group: bookings associated to a group, usually occupy more than 10 rooms per night.  
- previous_cancellations: number of previous cancellations prior to current booking by a customer.  
- previous_bookings_not_canceled: number of previous non - cancelled bookings prior to current booking by a customer.  
- booking_changes: number of changes made to the booking from when it was enterred into the system till the day of arrival/ cancellation.    
- agent: ID of travel agency that made the bookings.  
- company: ID of companies that made the bookings.  
- days_in_waiting_list: number of days booking was in the waiting list before it was confirmed to customers.  
- adr: Average Daily Rate, computed by taking total room revenue (excluded breakfast, tax and service charges) divided by total number of room nights sold.  

You may notice that some variables contained the "NULL" values (eg: agent or company variable). This "NULL" value did not mean the value was missing, rather such value did not exist to begin with; for example a booking may not have the ID of an agent or a company associated with it as such booking was made by an individual traveller.  

# Limitation


# Questions: Which factors would determine the cancellation rate?


# Analysis and findings

We started with 31 variables to look at, and really without any distinct direction, so we started off by loking at some of the most prominent features of hotels:

```{r var-choose}
hotel_mngt <- hotels %>%
  mutate(arrival_date = dmy(paste0(arrival_date_day_of_month, arrival_date_month, arrival_date_year, sep = "-"))) %>%
  select(hotel, arrival_date, arrival_date_week_number,arrival_date_month, arrival_date_year, lead_time,
         previous_cancellations, previous_bookings_not_canceled, deposit_type, booking_changes,deposit_type,
         agent, days_in_waiting_list, required_car_parking_spaces, total_of_special_requests, 
         reservation_status, reservation_status_date, customer_type, market_segment, adr) %>%
  # Tweaking a bit
  mutate(hotel = as.factor(hotel))
```

### Who are staying at the hotels? How are the prices different?

```{r customer-type}
customer_type <- hotel_mngt %>%
  # filter to check-out bookings only to ensure real number
  filter(reservation_status == "Check-Out") %>%
  select(hotel, customer_type, adr) %>%
  group_by(hotel, customer_type) %>%
  summarise(count = n(),
            avg_adr = mean(adr))
  
```


### Which channels hotels are selling through and at which price?
```{r channel}
distribution <- hotel_mngt %>%
  # filter to check-out bookings only to ensure real number
  filter(reservation_status == "Check-Out") %>%
  select(hotel, market_segment, adr) %>%
  group_by(hotel, market_segment) %>%
  summarise(count = n(),
            avg_adr = mean(adr))
```



### The high and low season: 
Booking and ADR by months, if possible guests type

```{r season}

```


### Reservation status
Then, we have a look at the reservation status of these two hotels. 

```{r cancel, fig.cap = "Reservation status by hotel type"}
hotel_status <- hotel_mngt %>%
  select(hotel, reservation_status, arrival_date_year) %>%
  group_by(hotel,arrival_date_year, reservation_status) %>%
  count()

# Plot reservation status by year and hotel
hotel_status %>% 
  ggplot(aes(x = arrival_date_year, y = n, fill = reservation_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~hotel) +
  theme_minimal() +
  xlab("year") +
  ylab("number of bookings") +
  labs(title = "Reservation status by hotel type")
```

Things to note about this plot:  
- 2016 seems to be the best year for both hotels in terms of total bookings. --> figure out why  
- Clearly city hotels have more bookings than resort hotel. Does that mean city hotels have more guests than resort hotel? Should check the LOS and number of guests/ rooms. Need a different section for this.  
- Cancellation seems to be a problem in city hotel. Visually number of cancelation in city hotel is higher than resort. We may want to check the proportion rather than the absolute number.  

We will look more in detail for each points:

```{r LOS}

```

*1a. 2016 is a wonderful year *

*1b. The higher the bigger?*

*1c. The one who got away*
Let's have a look at the dark-side of the hotel business - the cancellation. No hotels like cancellation, at least on a non - refund basis. How is the cancellation rate different from a city hotel to a resort?

```{r cancellation}
# what is the cancellation rate?
hotel_cancel <- hotel_mngt %>%
  select(hotel, arrival_date ,reservation_status) %>%
  group_by(hotel, reservation_status) %>%
  count() %>%
  pivot_wider(names_from = reservation_status, values_from = n, values_fill = 0) %>%
  mutate(total_bookings = Canceled + `Check-Out` + `No-Show`) %>%
  mutate(prop_cancel = round(Canceled/ total_bookings,4))

hotel_cancel %>%
  kable(caption = "Overall cancellation rate") %>%
  kable_styling(bootstrap_options = c("hover", "stripping"))
```

The overall cancelation rate of 3 years posed a striking difference between city hotel and resort: `r with(hotel_cancel, prop_cancel[match("City Hotel",hotel)])*100` percent vs `r with(hotel_cancel, prop_cancel[match("Resort Hotel",hotel)])*100` percent. What factor could possibly contribute to such difference? Did the problem come from the hotel itself or from whatever happened in the overall tourism industry at that point in time? 


--------- From here compared cancelled vs check-out----------------------------------------

Let's first put our common sense to test for some of the variables presented in the dataset and cross check with our analysis in the later parts:  
- Lead time and days in waiting list: will the booking times really mattered? Which bookings are more likely to be cancelled? The ones in the system longer or sooner?  
- Special requests, parking space requirement, booking changes:  
- is repeated guests or not:  
- previous cancellations and successful bookings:  
- deposit type:  

#### How do the cancellations have in common?

The Hotel's PMS recored the _lead time_, which is the number of days elapse between the entering date of the booking into the system and the arrival date, the _reservation status date_ and the _days in waiting list_, which is the number of days before the booking was confirmed with the customers. A high days in waiting list indicating that a booking takes longer to proceed and a high lead time indicating that the booking was made earlier prior to the arrival date.  

```{r}
cancel_only <- hotel_mngt %>%
  filter(reservation_status == "Canceled") %>%
  select(-arrival_date_week_number)
```

```{r system-days, fig.cap = "System days of cancellation bookings"}
# visualise the days in system and cancellation day
cancel_only %>%
  select(hotel, days_in_waiting_list, lead_time) %>%
  pivot_longer(-hotel, names_to = "system_day", values_to = "days") %>%
  ggplot(aes(x = system_day, y = days, fill = hotel)) +
  geom_boxplot() +
  theme_minimal() +
  xlab("Type of days") +
  labs(title = "System days of cancelled bookings")
```

Both hotels seems to proceed customers' bookings with great speed with the median waiting days around 0 days. However, city hotel had a lot of cancelled bookings that sat through a significantly high number of days in the system before they were confirmed to the customers. On an other note, city hotel had a high range of lead time and days in the system, signalling that bookings which were made too early prior arrival time may have higher chance of being cancelled.

We will look futher at this assumption, but this time comparing check-out with cancelled bookings to verify the impact of lead time and days in waiting list on the cancellation rate.  


**Check-out vs Cancelled**

We want to compare the days in waitng list and days in system for both hotels. Will a booking that takes too long to proceed (high days in waiting list) or is made too early before the arrival date (high lead time) more prone to cancellation?

```{r checkout}
status_compare <- hotel_mngt %>%
  filter(!reservation_status == "No-Show") %>%
  select(-arrival_date_week_number)
```

```{r checkout-plot, fig.cap = "System days of Check-out and Canceled"}
status_compare %>%
  select(hotel, reservation_status,lead_time, days_in_waiting_list) %>%
  pivot_longer(-c(hotel, reservation_status), names_to = "system_day", values_to = "days") %>%
  ggplot(aes(x = system_day, y = days, fill = reservation_status)) +
  geom_boxplot() +
  xlab("Type of days") +
  labs(title = "System days of bookings") +
  scale_fill_brewer(palette="Dark2")
```

At the first glance at figure \@ref(fig:checkout-plot), both types of bookings still maintained a median days of waiting as 0 days, cancelled bookings had a lower days in system compared to check-out, which was no surprises as cancellations usually are done days before the arrival date. However, lead time for cancelled bookings were much higher than of Check-out, except for the two outliners of check-out which exceed 650 days. This confirmed our assumption of lead time having an impact on the cancellation chance. The earlier the booking, the higher chance of cancellation. 

#### The one who got away

Having known which kind of the bookings are more likely to get cancelled, we are interested in knowing who were the one behind those bookings. We started by looking at the market segment of these cancellation:

```{r guest-anatomy}
cancel_anatomy <- hotel_mngt %>%
  select(- arrival_date_week_number, - arrival_date_month, - arrival_date_year, - reservation_status, - 
           reservation_status_date, hotel, market_segment, agent, arrival_date, deposit_type, 
         previous_cancellations, previous_bookings_not_canceled, required_car_parking_spaces, 
         total_of_special_requests, reservation_status)

cancel_mkt_segment <- cancel_anatomy %>%
  select(market_segment, reservation_status, hotel) %>%
  group_by(hotel, market_segment, reservation_status) %>%
  count() %>%
  pivot_wider(names_from = reservation_status, values_from = n, values_fill = 0) %>%
  ungroup() %>%
  mutate(total_booking = Canceled + `No-Show` + `Check-Out`,
         percent_cancel = round(Canceled/total_booking*100,2)) %>%
  arrange(desc(percent_cancel))
```

```{r guest-anatomy-plot, fig.cap = "Who are more likely to cancel?"}
cancel_mkt_segment %>%
  filter(!market_segment == "Undefined") %>%
  ggplot(aes(x = fct_reorder(market_segment, percent_cancel), y = percent_cancel)) +
  geom_bar(stat = "identity", fill = "#006DAE") +
  geom_text(aes(label = percent_cancel, hjust = 1), color = "white") +
  theme_classic() +
  coord_flip() +
  facet_wrap(~hotel) +
  xlab("market segment") +
  ylab("cancel percantage") +
  labs(title = "Cancellation rate by market_segment")
```

We calculate the cancellation rate by taking the _number of cancellation bookings_ divided by _total bookings_ for each market segment. From figure \@ref(fig:guest-anatomy-plot), we see that Groups had an impressive rate of cancellation at 68.44% for City hotel and 42.14% for Resort, followed by Travel agency/ tour operator (both offline and Online). City hotel noticably had the top 3 cancellation percentage at a much higher level than Resort. Aviation or Air crew only showed up in City hotel, which actually made sense as airlines only need a place for their air crew to stay over and it does not have to be at a fancy resort. 

Now that we know Groups were mostly the ones who defaulted the most, we hope to know the why they did what they did, i.e cancelled their bookings. Was this because of the deposit policy or their requests not being fullfilled? We moved on to look at deposit and other guest'sspecial requests in search for the reasons. 

#### Deposit policy

We gathered all the cancelled bookings and divided them by their deposit type.  

```{r deposit}
cancel_deposit <- cancel_anatomy %>%
  select(reservation_status, deposit_type) %>%
  group_by(reservation_status, deposit_type) %>%
  count(name = "count")
```

```{r deposit-plot, fig.cap = "Deposit type" }
p1 <- cancel_deposit %>%
  filter(reservation_status == "Canceled") %>%
  ggplot(aes(x = deposit_type, y = count, fill = deposit_type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(title = "Cancellation by deposit count") +
  xlab("deposit type")

p2 <- cancel_anatomy %>%
  select(reservation_status, deposit_type) %>%
  group_by(deposit_type, reservation_status) %>%
  count(name = "count") %>%
  pivot_wider(names_from = reservation_status, values_from = count, values_fill = 0) %>%
  mutate(prop_cancel = round(Canceled/(Canceled+`Check-Out`+`No-Show`),3)) %>%
  ggplot(aes(y = prop_cancel, x = deposit_type, fill = deposit_type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(title = "Cancellation by deposit percentage") +
  xlab("deposit type") 

grid.arrange(p1, p2, ncol = 2)
```

Figure \@ref(fig:deposit-plot) showed us something really interesting. If we looked at the absolute numbers of cancellation by counting the number of canceled bookings for each deposit type (left plot), we will have _no deposit_ as the highest with _non - refund_ followed by roughly a half. This came as no surprise as nowadays people were not expected to deposit for their stays, which made them more likely to cancel their bookings without spending a penny.  
However, if we looked at the cancel rate by deposit type which we took the canceled bookings divided by all the bookings under each deposit type (right plot), we had a quite counter-intuitive discover. The _non_refund_ now had the highest rate of cancellation, leaving the other two types far behind. This implied that people actually canceled the bookings that they had paid in advance! This insight called for further investigation, ideally with a different dataset of a a different hotel to verify its validity.


# Conclusion





# References

Definition https://str.com/sites/default/files/2019-11/str-data-reporting-guidelines-english-2019.pdf

