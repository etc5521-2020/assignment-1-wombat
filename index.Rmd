---
title: "ETC5521 Assignment 1"
subtitle: "An Initial Exploratory Of A Hotel Dataset"
team: WOMBAT
author:
  - Hai Hanh Ngo
  - Dewi Lestari Amaliah
date: "`r Sys.Date()`"
bibliography: references.bib
output: 
  bookdown::html_document2
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r library}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(gridExtra)
library(plotly) 
library(visdat)
library(countrycode)
library(DT)
library(maps)
library(viridis)
library(viridisLite)
library(naniar)
```


<br>


# Introduction 

Obtaining data from hotel industry has always been a real challenge. Whilst we can read about the hotel jargons and terms easily, scanned through some of the common descriptive statistics of the hotel industry in market research reports or seems to stand on top of the world by pocketing some of the "industry secret" provided by the Internet for price negotiating for your next summer trip, less is known about how a hotel actually runs behind the scene. This sad truth was foreseeable as no hotels would be willing to share their performance to the public eyes. Such limitation posed a challenge for researchers, scientists, hoteliers and many others to perform any studies relating to this industry.

The "hotel booking demand datasets" compiled by Nuno Antonio, Ana de Almeida and Luis Nunes [@AntonioNuno2019Hbdd] was a beautiful effort to overcome such challenge. This dataset was obtained from two hotels in Portugal - one city hotel in Lisbon and one resort in Algrave. Some of the sensitive information that could reveal the identity of the two hotels was not provided, but it did not affect the important role of this dataset for the purpose of education, management, machine learning and many others.

In this study, we performed some initial analysis on the dataset to help us answer one of the question we mentioned at the beginning, about how hotels performance actually looks like behind the scene. What can we learn about the way hotels manage their customers' info, how they priced our bookings or who are more likely to cancel their bookings.

We will mainly use R programming software for this analysis along with other research materials we could find on the internet. Graphical displays are mostly utilised to support our diagnostics and analysis

<br>


# Added Research Question (Siyi and Priya)

- Lets us further find out if there any relationship, between the customer type and the ADR(Average Daily Rate) in the two different hotel Types

- We, do not know, whether the meal type of the hotel data, can be inferred for the information of the length of stay of the guest. Let us try and find out if possible !! 

-In the generation of the added human intervention, cars play a huge role lets us find out whether there is any relationship between the the car parking space in the two different types of hotels mentioned in the dataset.



# Data description

## Dateset overview and structure

In 2018, Nuno Antonio, Ana de Almeida and Luis Nunes published a data article called "Hotel booking demand datasets" which introduced to the public two datasets for two hotels in Portugal, one resort in Algarve (H1) and one city hotel in Lisbon (H2). These datasets were originally collected to serve the development of prediction models to assess the hotels' likelihood of having their bookings cancelled, however the uses of variables included also allow other researching purposes. 

The datasets for the two hotels can be downloaded separately at [ScienceDirect.com](https://www.sciencedirect.com/science/article/pii/S2352340918315191) in the paper of @AntonioNuno2019Hbdd. However, @jthomasmock at _tidytuesday challenge_ had done us a favor and combined the two datasets into one. The two original datasets and the combined one can be obtained at this [GitHub page](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md). For this study, we used only the combined dataset.  

The dataset is stored in a _csv_ file format with 32 variables and 119,390 observations (40,060 for H1 and 79,330 for H2). Each observation represents one hotel booking. The format of the dataset is as below:

```{r load-data}
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')

glimpse(hotels)
```

Knowing this dataset belonged to a hotel, we can make sense most of the variables. However, not all of them are familiar for anyone who did not have a background of hotel management. We will run through some of the industry jargons and variables'meaning before we take a further look at the data.

Variables note:  

*  is_cancelled: (1) if the booking was cancelled and (0) if not.  
*  lead_time: number of days between when the booking was entered into the hotel's booking system and the |arrival date.  
*  meal:  Type of meal booked which can be:  
   +  BB: Bed and Breakfast.  
   +  FB: Full board (breakfast, lunch and dinner).  
   +  HB: Half board (breakfast and one meal, usually dinner).  
   +  Undefined/ SC: no meal package.  
* country:  Guests'country of origin.  
* market_segment: guests'market segment, some of which may associate with booking channel.    
   +  Direct: guests that make bookings directly with the hotels, could be from hotel's website/ phone booking or walk-ins.  
   +  Corporate: Guests whom bookings are made by corporate/ company or guests who are business travellers.    
   +  Online TA: Online travel agents - bookings that made through a third party websites. Examples are Agoda, Expedia, Booking.com...  
   +  Offline TA/TO: Bookings made by Travel agents or Tour operators.  
   +  Complementary: Free stays offered for guests, usually from hotels' promotional programs.    
   +  Groups: guests who travelled in groups.  
   +  Undefined: Undefined type of guests.  
   +  Aviation: We are not entirely sure but this could be airline crews.    
* Distribution_channel:   
   +  Direct: bookings that made directly with the hotels (hotel's websites, phone or walk-ins)  
   +  Corporate:  bookings made by corporate/company.
   +  TA/TO: Travel agents/ tour operators/    
   +  Undefined: Undefined distribution channel.  
   +  GDS: Global Distribution System. GDS served like a hub for companies in the travel industry (airlines, hotels, car rental...) to connect with travel agents. Hotels will put some of their inventories (rooms) to the GDS and travel agents then can sell those rooms to their customers. Some of the well-known GDS include Amadeus, Sabre and Galileo.   
* is_repeated_guess: (1) if repeated and (0) if not.   
* customer_type:    
    + Transient: Individuals or groups that occupy less than 10 rooms per night. These guests usually stay in the hotel short - term and require little services.  
    + Contract: bookings bound by contracts, usually for more than 30 days for a consistent block of rooms.  
    + Transient - Party: Transient booking but associated to other transient booking.   
    + Group: bookings associated to a group, usually occupy more than 10 rooms per night.  
* previous_cancellations: number of previous cancellations prior to current booking by a customer.  
* previous_bookings_not_canceled: number of previous non - cancelled bookings prior to current booking by a customer.  
* booking_changes: number of changes made to the booking from when it was enterred into the system till the day of arrival/ cancellation.    
* agent: ID of travel agency that made the bookings.  
* company: ID of companies that made the bookings.  
* days_in_waiting_list: number of days booking was in the waiting list before it was confirmed to customers.  
* adr: Average Daily Rate, computed by taking total room revenue (excluded breakfast, tax and service charges) divided by total number of room nights sold.  

You may notice that some variables contained the "NULL" values (eg: agent or company variable). This "NULL" value did not mean the value was missing, rather such value did not exist to begin with; for example a booking may not have the ID of an agent or a company associated with it as such booking was made by an individual traveller.  

<br>


## Limitation

* This dataset contained data for two specific hotels in Portugal. Such limitation in study objects introduced challenges when we attempted to explain the trends observed as reasons could be hotel- specific and we could not use industry knowledge to cover.  
* Some information of the hotels were not provided, for example the number of rooms, the occupancy rate, the location of the hotels (in the busy district or at the city suburban), years of operation or special events that might have occurred. The lack of information might render some of our questions unanswered.  
* Eventhough we were provided with the collection method, we were not be able to verify the validity and correctness of the data. We noticed during our analysis that some of the entries were not sensible and could very likely due to the input errors. However we were unable to verify such concern.  
* Since the observation began in July 2015 and ended in August 2017, we only have a fully cover data by year in 2016. Moreover, the coverage of the dataset in 2015 and 2017 are only six months and eight months, respectively. Hence, we would not analyze the data in year-wise manner because it might be not apple to apple to be compared. 

<br>

## Time Frame of Collection

The time frame covered in this data set is from 1st July of 2015 to 31st August of 2017, daily.

<br>

## Collection methods

@AntonioNuno2019Hbdd collected the data by extracting the variables from the hotels' PMS (Property Management System) databases' server with a TSQL query in SQL Server Studio Manager. The tables that were used to extract the variables are: 

1. BO (booking table in which the key, which is the ID, was retrieved).
2. BL (bookings change log, in this case, if the booking details with respect to the day before arrival changed, the value used was the one present in this table).
3. ML (meals).
4. DC (distribution channel).
5. TR (transaction).
6. CP (customer profiles).
7. NT (nationalities).
8. MS (market segments). 

A diagram below made by @AntonioNuno2019Hbdd presented the structure of the PMS databases: 

<center>

```{r pms-diagram, fig.cap = "PMS database diagrams"}
knitr::include_graphics(here::here("PMS_diagram.jpg"))
```
</center>

<br>

## Data Cleaning

### Missing values checking


@BennettDerrickA argued that it is important to take missing value into account, otherwise the statistical analysis will be misleading and variability of the data could not be estimated correctly. Thus, before analyzing the data, we checked the missing value using `visdat` package [@visdat] first. 

<center>

```{r missing-vals-check, cache = TRUE, fig.cap= "Variables Type and Missing Value Visualization"}

vis_dat(hotels, warn_large_data = FALSE)

```

</center>


```{r children-missing, eval = FALSE}

children_missing <- naniar::where_na(hotels$children)

```



Figure \@ref(fig:missing-vals-check) shows that there is no missing value in the dataset. It is inline with what @AntonioNuno2019Hbdd stated that there is no missing values in the database table. However, some "NULL" values were presented which should be interpreted as "not applicable", not a missing value [@AntonioNuno2019Hbdd]. For example, if the the **company** value is NULL, it means that the booking was not made by a company.

In `children` variable, when we checked the missing value using `naniar::where_na()` function by @naniar, we found that there are `r naniar::n_miss(hotels$children)` observations that are actually missing. Figure \@ref(fig:missing-vals-check) may did not capture it because the proportion is too low (`r naniar::n_miss(hotels$children)` out of `r nrow(hotels)` observations). We then treated these missing values by imputing it with the average of children (mean imputation) [@KangHyun2013Tpah] and created new variable called `imputed_children`. 


```{r imputing-ms}

average_children <- round(mean(hotels$children, na.rm = TRUE), 0)

imputed_children <- replace_na(hotels$children, average_children)

hotels <- cbind(hotels, imputed_children)
```


### Data Transformation


Figure \@ref(fig:missing-vals-check) also conveys the type of the variables in the dataset. We could see that a lot of variables (such as *hotel*, *distribution_channel*, and *is_canceled*) have incorrect type. Those variables should be a factor/categorical instead of a character or numeric variables. Therefore, the type of the data should be corrected before doing the analysis. We transformed the data type using `mutate` function from `tidyverse` @tidyverse and `as.factor` function from R built-in `base` package [@rcite]. Figure \@ref(fig:data-type) portrays that the variables have been in a correct type.

```{r}
hotels_corrected_type <- hotels %>%
  mutate(hotel = as.factor(hotel),
         is_canceled = as.factor(is_canceled),
         arrival_date_month = as.factor(arrival_date_month),
         arrival_date_year = as.factor(arrival_date_year),
         meal = as.factor(meal),
         country = as.factor(country),
         market_segment = as.factor(market_segment),
         distribution_channel = as.factor(distribution_channel),
         is_repeated_guest = as.factor(is_repeated_guest),
         reserved_room_type = as.factor(reserved_room_type),
         assigned_room_type = as.factor(assigned_room_type),
         deposit_type = as.factor(deposit_type),
         agent = as.factor(agent),
         company = as.factor(company),
         customer_type = as.factor(customer_type),
         reservation_status = as.factor(reservation_status))
```


<center>

```{r data-type, cache = TRUE, fig.cap= "Data Type Visualization"}
vis_dat(hotels_corrected_type, warn_large_data = FALSE)
```
</center>


We also created some variables by transforming or wrangling the original variable to analyze the data. Those variables are listed as follows:

1. `is_canceled_new`. This variable is actually the same with `is_canceled`. We only recoded the value from 0 and 1 to be "not canceled" and "canceled" in order to make it easier to interpret. 
2. `lengt_of_stay` is the number of days that the guests spend in the hotel. It is the summation of `stays_in_weekend_nights` and `stays_in_week_nights` variable.
3. `stay_on` is a categorical variable to observe whether the guests stayed in weekend, weekday, or both. 
4. `number_of_guest` is a summation of `adults`, `imputed_children`, and `babies` variables. 
5. `kids` is a summation of `imputed_children` and `babies` variables.
6. `family_type` is a categorical variable to observe whether the guest stayed with kids or not. 

The `lengt_of_stay` and `stay_on` would be used to analyze the staying pattern on the guests. Whilst `number_of_guest`, `kids`, and `family_type` would be used to analyze the type of guest who stayed at the hotel. Moreover, the dataset only provides the country of bookings with country codes coded in ISO code. Hence, we transform these code to the country name using `countrycode` package [@countrycode]. 


```{r}
hotels_new_data <- hotels_corrected_type %>%
  mutate(is_canceled_new = if_else(
           condition = is_canceled == 0,
           true = "not canceled",
           false = "canceled"),
         length_of_stay = stays_in_weekend_nights + stays_in_week_nights,
         stay_on = ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights != 0, "Weekday and Weekend",
                          ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights == 0, "Weekend", "Weekday")),
         number_of_guest = adults + imputed_children + babies,
         kids = imputed_children + babies,
         family_type = ifelse(kids != 0, "family", "not family"),
         arrival_month_year = paste0(arrival_date_month, arrival_date_year),
         semester = case_when(str_detect(arrival_month_year, "July2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "August2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "September2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "October2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "November2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "December2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "January2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "February2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "March2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "April2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "May2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "June2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "July2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "August2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "September2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "October2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "November2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "December2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "January2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "February2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "March2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "April2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "May2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "June2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "July2017") ~ "2017 Sem 2",
                              str_detect(arrival_month_year, "August2017") ~ "2017 Sem 2"))
```

<br>
<br>


# Analysis and findings

We started with 31 variables to look at, and really without any distinct direction, so we started off by looking at some of the most prominent features of hotels. We mainly incorporated the function from `tidyverse` [@tidyverse], `ggplot2` [@R-ggplot2], and `plotly` [@R-plotly]. We also used `lubridate` [@R-lubridate], `kableExtra` [@R-kableExtra], `gridExtra` [@R-gridExtra], `DT` [@R-DT], `maps` [@R-maps], `viridis` [@R-viridis], and `viridisLite` [@R-viridisLite]

```{r var-choose}
hotel_mngt <- hotels %>%
  mutate(arrival_date = dmy(paste0(arrival_date_day_of_month, arrival_date_month, arrival_date_year, sep = "-"))) %>%
  select(hotel, arrival_date, arrival_date_week_number,arrival_date_month, arrival_date_year, lead_time,
         previous_cancellations, previous_bookings_not_canceled, deposit_type, booking_changes,deposit_type,
         agent, days_in_waiting_list, required_car_parking_spaces, total_of_special_requests, 
         reservation_status, reservation_status_date, customer_type, market_segment, adr, is_repeated_guest, adults, children, babies) %>%
  # Tweaking a bit
  mutate(hotel = as.factor(hotel),
         year = as.numeric(arrival_date-arrival_date[1]) %/% 365+1)
```

<br>

## Seasonality: 

Tourism industry cares a lot about seasonality as it would affect the guest flows to tourist locations. Hotel season divided into two main seasons: the high and low season. As the name implies, high season is a busy season when the weather is favorable and the guests inflows are high; low season vice versa. Portugal is of no exception. The high season in Portugal usually runs in summer (June to September) and spring time (January to March) ; the beaches are usually the busiest in July and August. The low season usually falls in the winter season which starts around November and ends by the end of February. Weather during this period may feature humidity, unexpected rain and strong, cold breeze which is not too ideal for sightseeing [@lisbon]. 

Keeping the season time in mind, we are interested in finding out any possible influence seasonality may have on the guest count and ADR of our hotels in study. The analysis in this section took into account only "Check-out" or successful bookings to avoid inflating numbers. 

**Guest Count**

First, we tried to plot the guest count by month for each year to check if the seasonality is consistent through years (it should be unless some one - off events took place and disturbed the market). Problems arised when we wanted to look at the yearly subset of our records and as our dataset ran from 1 July 2015 to 31 August 2017, we could not group the data by their conventional year of 2015, 2016 and 2017. We decided to break down the dataset into three groups by allocating 12 months into each and called them year 1,2 and 3. As Year 3 only had 2 months, we dropped that year and focused only on two Year 1 (July 2015 - June 2016) and Year 2 (July 2016 to June 2017). The result is presented in figure \@ref(fig:guest-by-month) below. 

```{r season}
season <- hotel_mngt %>%
  select(hotel, arrival_date_month, year,reservation_status, customer_type, market_segment, adr, adults, children, babies) %>%
  # Choose successful bookings only to avoid distortion of adr
  filter(reservation_status == "Check-Out",
  # filter out bookings with ADR < 0 - there are bookings with negative adr!
         market_segment >= 0) %>%
  # convert month to factor for plotting purpose
  mutate(arrival_date_month = as.factor(arrival_date_month),
         total_guests = adults + children + babies)
```


<center>
```{r guest-by-month, fig.cap = "Number of guests by month"}
# Guests count by month
season %>%
  group_by(hotel, year, arrival_date_month) %>%
  summarise(total_guests = sum(total_guests)) %>%
  # Year 3 does not have full years (3 months only) so we used year 1 and 2
  filter(!year == 3) %>%
  # Grouping will make geom_line runs in a straight vertical line
  ungroup() %>%
  ggplot(aes(x = factor(arrival_date_month, levels = c("July", "August", "September", "October", "November", "December", "January", "February", "March", "April", "May", "June")), y = total_guests,
             group=factor(year), colour=factor(year))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~hotel) +
  labs(title = "Number of guests by month",
       x = "month",
       y = "total guests",
       colour = "Year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c("#000080", "#FF0000"))
```
</center>


The months are presented in the order of occurrence (July was the first year for each year) to ensure the choronological order of the dataset. The overall trend was roughly the same for both years and both hotels. The seasonality trend resembled the "W" shape with the lower points of W fell into the winter months from November to January and the peak points were in spring and summer time. Interestingly, both hotels saw the higest of guests in Spring time in Year 1 (May and March) whilst in year 2, the highest was observed in the summer time (August and October). 

There were some abnormalities, however, spotted, of which the most noticeable was that City hotel suffered a serious hit in guest counts in July 2015 whilst Resort saw no such event. This drop could be due to some hotel - specific reasons, for example the hotel might have closed down for some time for renovation; however we were unable to answer due to the lack of information of hotel's identity. Other abnormal notice could be a reverse trend in March of Resort. Again this abnormality could not be explained and we believed it was due to hotel - specific cause rather than industry - specific. 

Next we look at the **Average Daily Rate** or ADR in short. 

<center>

```{r ADR-by-month, fig.cap = "ADR by month"}
# ADR by months
adr <- season %>%
  group_by(hotel, year, arrival_date_month) %>%
  # Year 3 does not have full years (3 months only) so we used year 1 and 2
  filter(!year == 3) %>%
  summarise(avg_adr = mean(adr)) %>%
  # Grouping will make geom_line runs in a straight vertical line
  ungroup() %>%
  ggplot(aes(x = factor(arrival_date_month, levels = c("July", "August", "September", "October", "November", "December", "January", "February", "March", "April", "May", "June")), y = avg_adr,
             group=factor(year), colour=factor(year))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~hotel) +
  labs(title = "Adr by month",
       x = "month",
       y = "currency",
       colour = "Year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c("#000080", "#FF0000"))

ggplotly(adr)
```
</center>

Unlike figure \@ref(fig:guest-by-month), figure \@ref(fig:ADR-by-month) showed a striking difference between the two hotels. Resort had the highest rates in the summer time, which make sense as Algrave is a beach area. Both hotels recorded the lowest rates in winter, however City hotel observed less fluctuation than resort. 

We noticed that in the dataset, some of the bookings recorded a very low ADR (less than 10 euros), some may even down to 1 Euro for non - complimentary rooms in both hotels. This may seem a little strange and could created an impact on the ADR we plotted above in figure \@ref(fig:ADR-by-month). However, we chose not to exclude those adr as we did not know the pricing policy of the hotels in question. 

<br>

## Exploring the Hotels' Market Segment


According to @meier, a relevant market segment is one of the key to be successful in hotel management, especially to set the price correctly. Therefore, it is essential to define the distribution of these hotels market segment. 

Figure \@ref(fig:market-segment) shows that the vast majority of bookings in both hotel were made through Online Travel Agent (OTA). In addition, the portion of bookings through OTA was bigger in the city hotel than in the resort hotel. In contrast with the city hotel, we could see more portion of direct bookings in the resort hotel than group bookings.

A study from [Phocuswright](https://www.pegs.com/blog/why-do-travelers-prefer-booking-with-otas/) in @pegs stated that one of the major reason of why do the people book trough OTA is beacuse the website is easy to use. Meanwhilst, @howe argued that OTAs are favorable because its easy booking option. According to @jedina2017exploring in @TalwarShalini2020Wdpp, the factors for booking the hotel through OTA are the accessibility, pricing, review accountability, and the customer services. 


<center>


```{r market-segment, fig.cap = "The distribution of hotel market segment in the city and resort hotel (2015-2017)"}

ms_change <- ggplot(hotels_new_data) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  theme_classic()
  

ggplotly(ms_change)

```
</center>


To look further how the OTA has became the main player of these hotels market segment, we plotted the booking against the time, in this case is semester-wise. We chose this time frame because we have the full semester-wise data each year until the first semester of 2017. Hence, the comparison would be apple to apple.  

<center>
```{r semester-ms-plot, fig.cap = "The distribution of hotel market segment in the city and resort hotel by semester" }

semester_ms_plot <- ggplot(filter(hotels_new_data, semester != "2017 Sem 2")) +
  geom_bar(aes(x = semester, 
               fill = market_segment), 
           position = "fill") +
  xlab("Time") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  facet_wrap(~hotel) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(semester_ms_plot)


```

</center>

Figure \@ref(fig:semester-ms-plot) shows that the OTA has taken over the domination of group bookings in the city hotel only in a half of year period. The proportion of the OTA in the first semester of 2016 has been doubled than the previous semester. Whilst in the resort hotel, the bookings trough OTA has been dominating since the beginning of the period observed. In contrast to the city hotel, in the first semester of 2016, the bookings through OTA slightly decreased and the group booking increased. We could also see that the proportion OTA bookings reached the peak in semester 2 of 2016 in both hotels. 

Aside from OTA matter, Figure \@ref(fig:semester-ms-plot) shows another interesting fact that in the condition of OTA booking was dominating the market segment, the proportion of direct booking in the resort hotel was relatively stable. However, this data set do not provide any information to investigate this matter deeper. Our guess is that may be this resort has their own way to promote their direct booking, for example may be through a loyalty voucher. 

To gain more insight from the market segment, especially to examine how much the OTA bookings would have contributed to hotels' revenue, we need to know the distribution the ADR from each market segment. From Figure \@ref(fig:guest-anatomy-plot), we could see that despite the high number of booking from the Online TA, the cancellation rate from this market segment was also relatively high. Hence, we should examine the distribution of hotel guests from the actual bookings only, which is the guests who did not cancel the booking. It is because only this kind of booking that would bring the actual revenue for the hotels.


```{r actual_guest}
actual_guest <- hotels_new_data %>%
  filter(is_canceled == 0)
```


<center>

```{r actual-guest-ms, fig.cap= "The distribution of hotels' actual guest by market segment"}

actual_guest_ms <- ggplot(actual_guest) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  theme(legend.title = element_blank(),
        text = element_text(size = 8)) +
  ylab("Proportion") +
  xlab("Hotel") +
  theme_classic()

ggplotly(actual_guest_ms)
```

</center>


Figure \@ref(fig:actual-guest-ms) conveys that most of actual guest in both hotels made the bookings through OTA, eventhough the cancellation rate from this market segment was also high. The reason might be because the portion of OTA booking was already big and the other categories also made cancellations. 

Since *aviation*, and *corporate* categories share fewer proportion of bookings compared to the others, we would recode these categories into *other* category. In addition, we would exclude the bookings that belong to *complementary* type since in the price analysis, these categories actually would not give any revenue to the hotels. 


```{r recode}
actual_guest <- actual_guest %>%
  filter(market_segment != "Complementary") %>%
  mutate(market_segment_new = case_when(
    str_detect(market_segment, "Aviation") ~ "Other",
    str_detect(market_segment, "Corporate") ~ "Other",
    str_detect(market_segment, "Direct") ~ "Direct",
    str_detect(market_segment, "Groups") ~ "Groups",
    str_detect(market_segment, "Offline TA/TO") ~ "Offline TA/TO",
    str_detect(market_segment, "Online TA") ~ "Online TA"))


#check if there is a miss recode
#filter(actual_guest, is.na(market_segment_new))
```


In the dataset, we do not have any information about the ADR by the room type. In fact, this variable would determine the booking rate. Therefore, in order to get unbiased insight, we would analyze the ADR by the room type. 


```{r adr-null}

adr_null <- filter(actual_guest, adr == 0)

p_adr_null <- round(nrow(adr_null)/nrow(actual_guest)*100, 2)

```


We could not also also find any information of the currency used in the ADR variable. Thus, we assumed that the ADR is stated in Euro since these hotels are located in Portugal.  

Figure \@ref(fig:adr-ms) shows that the distribution of ADR based on the market segment across room type was heterogeneous.  We could also found many outlier observations. The median of ADR shown in Figure \@ref(fig:adr-ms) also indicates a price competition between direct and OTA booking in both hotels. This finding is somehow in line with the current "war" between direct on OTA booking in the hotel industry. According @loxley and @skift to  as the booking transaction through OTA increased, so did the commission rate per booking that the hotels have to pay. The hotel then fight back to urge direct booking through the pricing [@phocuswire]. 

From this finding, we could also learn that from the customer perspective, it is might be better to book the hotel through group booking or offline travel agent because they were cheaper.


<center>

```{r adr-ms, fig.width = 10, fig.height=7, fig.cap = "The distibution of ADR by assigned room type in the city and resort hotel"}

adr_ms <- ggplot(filter(actual_guest, adr >= 0)) +
  geom_boxplot(aes(x = market_segment_new,
               y = adr, fill = market_segment_new)) +
  facet_grid(hotel ~ assigned_room_type) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_blank(),
        text = element_text(size = 8)) +
  ylab("ADR (Euro)")+
  xlab("Market Segment") 


#centering the legend position
ggplotly(adr_ms) %>%
  layout(legend = list(orientation = "h",
                       x = 0.2, y = -0.1))
  
```

</center>



From this exploration, we could tell that the online travel agent has dominated the market segment both in the city and resort hotels. In the city hotel, the domination began in first semester of 2016, whilst in the resort, it has began from the beginning of the period observed. In addition, the median of ADR based on market segment indicates an evidence of competition between direct and OTA bookings.    


<br>

## Where Did The Bookings Come From?

Another way to gain more insight about the market is to examine the origin of the travelers that book the hotel room. It is important to understand their behavior and preference. Hence, the hoteliers are able to develop strategies to attract them. 

```{r country-check}

# check if there is undefined country in the hotel bookings

#dplyr::distinct(hotels_new_data, country)

# Apparently, there is also a null observation in the country name. 
# We would like to know the percentage of this null country observation.

null_country <- hotels_new_data %>% filter(country == "NULL")
p_null_country <- round(nrow(null_country)/ nrow(hotels_new_data) * 100, 3)


```

Firstly, we would like to observe the distribution of the country of the origin of the bookings in both hotel. This dataset indeed does not have any missing value, but it has a NULL value, which means that we can not gain any insight from these observations. Thus, before doing the analysis, we check for the NULL value in the country variable first. We found that `r p_null_country` percent of observations have a NULL value in their country variable. In this case we omitted these observations because the number of observations is large enough and the proportion of NULL cases is relatively small [@KangHyun2013Tpah].

```{r bookers-table}

book_origin <- hotels_new_data %>% filter(country != "NULL") %>% 
  group_by(country) %>%
  count(country) %>%
  arrange(desc(n)) %>%
  ungroup

# The country comes in ISO3 name, in order to get better interpretation, we recode the country to its actual name

country_name <- countrycode(book_origin$country, "iso3c", "country.name")

book_origin_new <- cbind(book_origin, country_name)

#countrycode function could not find the match of "CN" and "TMP", so we changed it manually

book_origin_new[13,3] = "CN"
book_origin_new[130,3] = "East Timor"

col_order <- c("country", "country_name", "n")

book_origin_table <-  book_origin_new[, col_order]

```


Figure \@ref(fig:bookings-map) provided the map of the bookings origin country to get a view of the distribution of the bookings. 

<center>

```{r bookings-map, fig.cap = "The distibution of travelers origin who books the hotels in 2015-2017"}

world_map <- map_data("world")
bookings_map_dat <- left_join(book_origin_table, world_map, by = c("country_name" = "region"))

bookings_map <- ggplot(bookings_map_dat, aes(long, lat, group = group))+
  geom_polygon(aes(fill = n ), color = "white") +
  scale_fill_viridis("C")+
  theme_bw()

ggplotly(bookings_map)

```

</center> 

If we hover to the map, we found that the bookings came from most of the country across the world. In order to get a detail view, we provided the table of the 'bookings' country of origin. The table suggests that the bookings came from `r nrow(book_origin_table)` different countries.

<br>

```{r origin_table}
DT::datatable(book_origin_table, colnames = c("Country Code", "Country Name", "Number of Bookings"),
              caption = "The number of hotel bookings based on bookings country of origin")
```

<br>


By country-wise, most bookings were from Portugal. However the number of bookings made by international travelers are also a lot, especially from the European countries. In the further analysis, we would categorize the bookings into two categories, namely "local" and "international".  

```{r mutate-origin}

# Create new variable which categorize the origin of travelers.
# We omitted the country observations that are equal to NULL

origin_cat <- hotels_new_data %>%
  filter(country != "NULL") %>%
  mutate(origin = if_else(
           condition = country == "PRT",
           true = "local",
           false = "international"))

```



<center>

```{r origin-plot, fig.cap = "Bookings in city and resort hotel by country of origin"}

origin_plot <- ggplot(origin_cat) +
  geom_bar(aes(x = hotel, 
               fill = origin), 
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  scale_fill_manual(values = c("#F1C40F", "#5DADE2"))+
  theme_classic()

ggplotly(origin_plot)

```

</center>


Figure \@ref(fig:origin-plot) portrays that the international booking was dominating in both hotels. Somehow, the portion pattern is quite similar to the pattern of the bookings that made by OTA in the Figure \@ref(fig:market-segment). Therefore it is interesting to examine the market segment of the international bookings. 

<center>

```{r origin-ms, fig.cap = "Distribution of international travelers by market segment"}

origin_ms <- ggplot(filter(origin_cat, origin == "international")) +
  geom_bar(aes(x = hotel, 
               fill = market_segment), 
           position = "fill") +
  xlab("Hotel") +
  ylab("Proportion") +
  theme(text = element_text(size = 8))+
  theme_classic()

ggplotly(origin_ms)


```

</center>

<br>

According to Figure \@ref(fig:origin-ms), vast majority of international bookings were made through OTA in both hotels. This fact, once again, proved the OTA dominance in the hospitality industry. One interesting fact is that in the resort, many international travelers also booked through offline TA/TO. 

We were curious whether the international travelers pay more than the local travelers. It is actually interesting question since most of bookings came from abroad. To answer this question we would only, again, using the data from actual bookings. In addition, to avoid bias in the interpretation, we would only use the observations from the same room type. According to Figure \@ref(fig:room-dist), we would use the observations from room type "A" due to the high shares of these categories in both hotels.

<center>

```{r room-dist, fig.cap = "Room type distribution of hotels' guests"}

room_dist_origin <- ggplot(filter(origin_cat,  is_canceled == 0)) +
  geom_bar(aes(x = hotel,
               fill = assigned_room_type),
           position = "fill") +
  xlab("") +
  ylab("Proportion") +
  theme(text = element_text(size = 4)) +
  theme_classic() 


ggplotly(room_dist_origin) %>%
  layout(legend = list(orientation = "h",
                       x = 0.1, y = -0.1))

```

</center>

Another fact presented in Figure \@ref(fig:room-dist) is that the room type booked were more varied in the resort hotel, whilst in the city hotel, the room choice polarized to room type A and D. This finding could be a fruitful insight that the city hotel could improve their service to these best seller rooms. 

<center>

```{r adr-origin-boxplot, fig.cap="Distribution of ADR by guest origin in the city and resort hotel"}

adr_origin <- filter(origin_cat, is_canceled == 0 & assigned_room_type == "A")

adr_origin_boxplot <- ggplot(adr_origin) +
  geom_boxplot(aes(x = origin,
               y = adr, fill = origin)) +
  xlab("Guests Origin") +
  ylab("ADR (Euro)") +
  facet_wrap(~ hotel) +
  theme(text = element_text(size = 8)) +
  scale_fill_manual(values = c("#F1C40F", "#5DADE2"))+
  theme_classic()

ggplotly(adr_origin_boxplot)
```
</center>


In Figure \@ref(fig:origin-plot), we found the fact that most bookings in both hotels are from international travelers and the ADR median presented in Figure \@ref(fig:adr-origin-boxplot) shows that they paid more money than the locals in both types of hotel. Hence, we could argue that these travelers has became the valuable customers to the hotels. 

Since the foreign travelers has became the valuable guest to the hotel, it is better to maintain them as future long-term customer through personalization. According to @criton personalisation is the key to winning the heart of the customer. Therefore, the hotels should have a guest profile which enable them to make guest personalisation. @siteminder mentioned that the guest profile including but are not limited to preferred length of stay and activities engaged in. Thus, using the dataset, we would try to get the information of the guest profile, in this case, the international guest.   


**Weekend or Weekday? Why Not Both!**

```{r same-day-checkout}

same_day_checkout <- origin_cat %>% filter(length_of_stay == 0 & is_canceled == 0 & reservation_status == "Check-Out")

same_day_checkout_intl <- filter(same_day_checkout, origin == "international")
p_same_day_checkout_intl <- round(nrow(same_day_checkout_intl)/nrow(same_day_checkout)*100, 2)
  
```


During the exploration, we found an interesting case in which the guests did not spend any night in the hotel neither they canceled the bookings and no show. It means that the guest checked out in the same day they checked in. There are `r nrow(same_day_checkout)` actual bookings where the guests did a same day check out and we found that `r p_same_day_checkout_intl` percent are international bookings. 

We observed further by checking the distribution of international guest who were really spend the nights at the hotels. We found in Figure \@ref(fig:length-of-stay-hist-city), that most guest in the city hotel spent 3 days in the city hotel. In the resort hotel, most guests spent longer, which is 7 days (Figure \@ref(fig:length-of-stay-hist-resort)). In addition, generally, the length of stay of the guests in the city hotel was relatively shorter than the guest in the resort hotel. In the resort, the guests length of stay was also more varied. These facts are not surprising because typically resort guest intentionally want to spend more days in the resort and enjoy their service. Meanwhile, the city hotel guests might be a regular travelers who wanted to explore Lisbon or did a Europe trip. 


<center>

```{r length-of-stay-hist-city, fig.cap= "Length of stay of international guest in the city hotel", out.width= "50%"}

city_long_stay <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "City Hotel")) +
  geom_histogram(aes(x = length_of_stay, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "white",
                 fill = "#F1948A",
                 show.legend = FALSE) +
  #scale_x_continuous(breaks = seq(0, 60, by=5)) +
  xlab("Length of Stay") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent)+
  theme_classic()

ggplotly(city_long_stay)
```


```{r length-of-stay-hist-resort, fig.cap= "Length of stay of international guest in the resort hotel", out.width= "50%"}

resort_long_stay <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "Resort Hotel")) +
  geom_histogram(aes(x = length_of_stay, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "white",
                 fill = "#3ED9DE",
                 show.legend = FALSE) +
  #scale_x_continuous(breaks = seq(0, 60, by=5)) +
  xlab("Length of Stay") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()

ggplotly(resort_long_stay)
  
```

</center>



Further, regarding the activity that the guest may engaged in, we would like to figure it out by looking at when is the time that the guest stayed at most and observing the type of guest. 

Figure \@ref(fig:when-stay-plot) shows that both in the city and resort hotel, the proportion of weekend stay bookings were the smallest. In the city hotel, most of international guests stayed in weekend and weekdays. It is also found in the resort hotel, but the portion was bigger, may be because most of guest stayed for 7 days. 


<center>

```{r when-stay-plot, fig.cap= "The distribution of time the guest stayed at the hotels", out.width="50%"}

when_stay_plot <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0)) +
  geom_bar(aes(x = hotel,
               fill = stay_on),
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  theme_classic()
  

ggplotly(when_stay_plot)

```
</center>

<br>

**Family Doesn't Matter, Couple Does.**

Now, we want to look at the type of international guest who stayed in both hotels. Here, we classified them by "family", which is the guest that travel with kids, and "not a family". Figure \@ref(fig:family-plot) portrays that the vast majority of guest in both city and resort hotel were not traveling with kids. The proportion in both hotels even exactly the same. 

<center>
```{r family-plot, fig.cap = "Type of International Guest in The City and Resort Hotel"}

family_plot <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0)) +
  geom_bar(aes(x = hotel,
               fill = family_type),
           position = "fill") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  theme_classic()
  

ggplotly(family_plot)

```
</center>


We then look further to the actual number of the guests and found that most guest in the city and resort hotel came in couple. However, the percentage of couple guest in resort is higher in the resort than in the city hotel. 

<center>
```{r, message = FALSE, out.width = "50%", fig.cap = "The distribution of the number of international guest in the city hotel"}

number_of_guest_hist_city <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "City Hotel")) +
  geom_histogram(aes(x = number_of_guest, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "white",
                 fill = "#F1948A",
                 show.legend = FALSE) +
  #scale_x_continuous(breaks = seq(0, 60, by=5)) +
  xlab("Number of Guest") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()

ggplotly(number_of_guest_hist_city)

```
</center>

<center>
```{r, message = FALSE, out.width = "50%", fig.cap = "The distribution of the number of international guest in the resort hotel"}

number_of_guest_hist_resort <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "Resort Hotel")) +
  geom_histogram(aes(x = number_of_guest, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "white",
                 fill = "#3ED9DE",
                 show.legend = FALSE) +
  xlab("Number of Guest") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()

ggplotly(number_of_guest_hist_resort)



```
</center>


From this exploration, we got an insight that most of booking is the two hotels are international bookings. Most of them booked the room through OTA and pay more high price then the locals in both hotels. When we looked deeper, in general, they spent a lot more time in the resort hotel, compared to the city hotel. To make a personalisation to optimize guest experience, both hotels can engage more activity for couple both in weekdays and weekend.   

<br>

## Reservation status
Another thing we can look at for the sake of comparison is the reservation status of these two hotels at figure \@ref(fig:cancel) below:

<center>
```{r cancel, fig.cap = "Reservation status by hotel type"}
hotel_status <- hotel_mngt %>%
  select(hotel, reservation_status, arrival_date_year) %>%
  group_by(hotel,arrival_date_year, reservation_status) %>%
  count()

# Plot reservation status by year and hotel
hotel_status %>% 
  ggplot(aes(x = hotel, y = n, fill = reservation_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_classic() +
  xlab("") +
  ylab("number of bookings") +
  labs(title = "Reservation status by hotel type")
```
</center>

Cancellation seems to be a problem in city hotel. Visually, the number of cancelation in city hotel was way higher than resort. However, since the total number of bookings in the two hotels were very different to begin with, we might want to check the proportion rather than the absolute number.   

```{r cancellation}
# what is the cancellation rate?
hotel_cancel <- hotel_mngt %>%
  select(hotel, arrival_date ,reservation_status) %>%
  group_by(hotel, reservation_status) %>%
  count() %>%
  pivot_wider(names_from = reservation_status, values_from = n, values_fill = 0) %>%
  mutate(total_bookings = Canceled + `Check-Out` + `No-Show`) %>%
  mutate(prop_cancel = round(Canceled/ total_bookings,4))

hotel_cancel %>%
  kable(caption = "Overall cancellation rate") %>%
  kable_styling(bootstrap_options = c("hover", "stripping"))
```

In table \@ref(tab:cancellation), the overall cancelation rate of 3 years posed a striking difference between city hotel and resort: `r with(hotel_cancel, prop_cancel[match("City Hotel",hotel)])*100` percent vs `r with(hotel_cancel, prop_cancel[match("Resort Hotel",hotel)])*100` percent. What factor could possibly contribute to such difference? Did the problem come from the hotel itself or from whatever happened in the overall tourism industry at that point in time? To answer that question, we proceed to find out the common points in both hotel's cancellation pool. 

**How do the cancellations have in common?**

The Hotel's PMS recored the _lead time_, which is the number of days elapse between the entering date of the booking into the system and the arrival date, the _reservation status date_ and the _days in waiting list_, which is the number of days before the booking was confirmed with the customers. A high days in waiting list indicating that a booking takes longer to proceed and a high lead time indicating that the booking was made earlier prior to the arrival date.  

```{r}
cancel_only <- hotel_mngt %>%
  filter(reservation_status == "Canceled") %>%
  select(-arrival_date_week_number)
```

<center>

```{r system-days, fig.cap = "System days of cancellation bookings"}
# visualise the days in system and cancellation day
cancel_only %>%
  select(hotel, days_in_waiting_list, lead_time) %>%
  pivot_longer(-hotel, names_to = "system_day", values_to = "days") %>%
  ggplot(aes(x = system_day, y = days, fill = hotel)) +
  geom_boxplot() +
  theme_classic() +
  xlab("Type of days") +
  labs(title = "System days of cancelled bookings")

```
</center>

Both hotels seems to proceed customers' bookings with great speed with the median waiting days at around 0 days. However, city hotel had a lot of canceled bookings that sat through a significantly high number of days in the system before they were confirmed to the customers. On other note, city hotel had a high range of lead time and days in the system, signalling that bookings which were made too early prior arrival time may have higher chance of being canceled.

We will look further at this assumption, but this time comparing check-out with canceled bookings to verify the impact of lead time and days in waiting list on the cancellation rate.  

**Check-out vs Canceled**

We want to compare the days in waiting list and days in system for both hotels. Will a booking that takes too long to proceed (high days in waiting list) or is made too early before the arrival date (high lead time) more prone to cancellation?

```{r checkout}
status_compare <- hotel_mngt %>%
  filter(!reservation_status == "No-Show") %>%
  select(-arrival_date_week_number)
```

<center>
```{r checkout-plot, fig.cap = "System days of Check-out and Canceled"}
status_compare %>%
  select(hotel, reservation_status,lead_time, days_in_waiting_list) %>%
  pivot_longer(-c(hotel, reservation_status), names_to = "system_day", values_to = "days") %>%
  ggplot(aes(x = system_day, y = days, fill = reservation_status)) +
  geom_boxplot() +
  xlab("Type of days") +
  labs(title = "System days of bookings") +
  theme_classic() +
  scale_fill_brewer(palette="Dark2")
```
</center>

At the first glance at figure \@ref(fig:checkout-plot), both types of bookings still maintained a median days of waiting as 0 days, cancelled bookings had a lower days in system compared to check-out, which was no surprises as cancellations usually are done days before the arrival date. However, lead time for cancelled bookings were much higher than of Check-out, except for the two outliners of check-out which exceed 650 days. This confirmed our assumption of lead time having an impact on the cancellation chance. The earlier the booking, the higher the chance of cancellation. 

**The one who got away**

Having known which kind of the bookings are more likely to get cancelled, we are interested in knowing who were the one behind those bookings. We started by looking at the market segment of these cancellation:

```{r guest-anatomy}
cancel_anatomy <- hotel_mngt %>%
  select(reservation_status, hotel, market_segment, agent, arrival_date, deposit_type, 
         previous_cancellations, previous_bookings_not_canceled, required_car_parking_spaces, 
         total_of_special_requests, reservation_status, is_repeated_guest)

cancel_mkt_segment <- cancel_anatomy %>%
  select(market_segment, reservation_status, hotel) %>%
  group_by(hotel, market_segment, reservation_status) %>%
  count() %>%
  pivot_wider(names_from = reservation_status, values_from = n, values_fill = 0) %>%
  ungroup() %>%
  mutate(total_booking = Canceled + `No-Show` + `Check-Out`,
         percent_cancel = round(Canceled/total_booking*100,2)) %>%
  arrange(desc(percent_cancel))
```

<center>
```{r guest-anatomy-plot, fig.cap = "Who are more likely to cancel?"}
cancel_mkt_segment %>%
  filter(!market_segment == "Undefined") %>%
  ggplot(aes(x = fct_reorder(market_segment, percent_cancel), y = percent_cancel)) +
  geom_bar(stat = "identity", fill = "#006DAE") +
  geom_text(aes(label = percent_cancel, hjust = 1), color = "white") +
  theme_classic() +
  coord_flip() +
  facet_wrap(~hotel) +
  xlab("market segment") +
  ylab("cancel percantage") +
  labs(title = "Cancellation rate by market_segment")
```
</center>

We calculate the cancellation rate by taking the _number of cancellation bookings_ divided by _total bookings_ for each market segment. From figure \@ref(fig:guest-anatomy-plot), we see that Groups had an impressive rate of cancellation at 68.44% for City hotel and 42.14% for Resort, followed by Travel agency/ tour operator (both offline and Online). City hotel noticably had the top 3 cancellation percentage at a much higher level than Resort. Aviation or Air crew only showed up in City hotel, which actually made sense as airlines only need a place for their air crew to stay over and it does not have to be at a fancy resort. 

Now that we know Groups were mostly the ones who defaulted the most, we hope to know the why they did what they did, i.e cancelled their bookings. Was this because of the deposit policy or their requests not being fullfilled? We moved on to look at deposit and other guest's special requests in search for the reasons. 

**Deposit policy**

We gathered all the cancelled bookings and divided them by their deposit type.  

```{r deposit}
cancel_deposit <- cancel_anatomy %>%
  select(reservation_status, deposit_type) %>%
  group_by(reservation_status, deposit_type) %>%
  count(name = "count")
```

<center>
```{r deposit-plot, fig.cap = "Deposit type" }
p1 <- cancel_deposit %>%
  filter(reservation_status == "Canceled") %>%
  ggplot(aes(x = deposit_type, y = count, fill = deposit_type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(title = "Cancellation by deposit count") +
  xlab("deposit type")

p2 <- cancel_anatomy %>%
  select(reservation_status, deposit_type) %>%
  group_by(deposit_type, reservation_status) %>%
  count(name = "count") %>%
  pivot_wider(names_from = reservation_status, values_from = count, values_fill = 0) %>%
  mutate(prop_cancel = round(Canceled/(Canceled+`Check-Out`+`No-Show`),3)) %>%
  ggplot(aes(y = prop_cancel, x = deposit_type, fill = deposit_type)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  labs(title = "Cancellation by deposit percentage") +
  xlab("deposit type") 

grid.arrange(p1, p2, ncol = 2)
```
</center>


Figure \@ref(fig:deposit-plot) showed us something really interesting. If we looked at the absolute numbers of cancellation by counting the number of canceled bookings for each deposit type (left plot), we will have _no deposit_ as the highest with _non-refund_ followed by roughly a half. This came as no surprise as nowadays people were not expected to deposit for their stays, which made them more likely to cancel their bookings without spending a penny.  
However, if we looked at the cancel rate by deposit type which we took the canceled bookings divided by all the bookings under each deposit type (right plot), we had a quite counter-intuitive discover. The _non_refund_ now had the highest rate of cancellation, leaving the other two types far behind. This implied that people actually canceled the bookings that they had paid in advance! This insight called for further investigation, ideally with a different dataset of different hotels to verify its validity.

**Other special requests**

Finally, we wanted to know dig a little bit further into the bizarre finding we made earlier. What made people threw away good money by canceling the bookings they had paid before actually arrived at the premises? Could it be because per each deposit type, the hotels could not answer their requests (lacks parking spaces, unable to respond to special requests)? We will try to look at these elements for each deposit type to find out.  

We will compute the percentage of repeated guests for all bookings, average number of previous cancellations, successful bookings, car parking space requests and special requests.   

<center>
```{r request}
cancel_request <- cancel_anatomy %>%
  select(-hotel, - agent, - arrival_date, - agent, - market_segment) %>%
  # filter(reservation_status == "Canceled") %>%
  group_by(deposit_type) %>%
  summarise(bookings_count = n(),
            percent_repeated_guest = sum(is_repeated_guest == 1)/bookings_count,
            previous_cancellations = mean(previous_cancellations),
            previous_successful_booking = mean(previous_bookings_not_canceled),
            car_parking_space = mean(required_car_parking_spaces),
            special_requests = mean(total_of_special_requests))

cancel_request %>%  
  kable(caption = "Summary statistics") %>%
  kable_styling(bootstrap_options = c("hover", "stripped")) %>%
  row_spec(2, bold = T, background = "#ffd700")
  
```

</center>

Table \@ref(tab:request) added more to the confusion when non-refund bookings had customers who were either quite new to the hotels (low % of repeated guests) or had made a lot of cancellations before (highest previous cancellations, lowest successful booking), rarely required parking space (lowest average requests for car parking space) and rarely posed special requests (lowest average special requests) yet still willing to pay in advance only to cancel later. To put in plain words, these customers were either too pissed off in the past (high previous cancellations), too new to the hotels or not too picky but still decided to pay first and lost all the advance payment by abandoning the bookings. This point clearly asked for further investigation to decide whether this is hotel-specific or industry-specific.  

<br>

# Conclusion
In this study, we tried to explore the dataset in many angels. We started by comparing the two hotels featured in this study across all of the variables provided in the dataset. 

We found out that the two hotels followed the overall seasonality trend in Portugal where high season fell in the spring and summer time. The ADR for two hotels were priced at a different rates with City hotel observed less fluctuation than Resort did. Also, by market segment, the ADR of the OTA and Direct booking channel appreared to be quite competitive even though the OTA's prices were still a bit better. 

By guests origin, around 40% - 44% of the bookings were from local tourists. A vast majority of international guests were delivered through OTA channel (50% - 68%) which again emphasized the influence of this channel over the hotel industry. We also learnt that it was the international guests who paid more for the services and the room choices. 

Another thing we could learn of the guests'behaviour was that guests would spend more days in resort rather than city hotel. Our dataset pointed out that resort had a handful of guests staying for up to 7 days whilst in the city hotel was 3 days. There were 675 cases recorded where guests did not stay overnight and 14.07% of those were of international travellers, higlighting a difference that locations of the two hotels could make with the resorts being in the beach area of Algrave and the city hotels in Lisbon where guests might be a regular travelers who wanted to explore Lisbon or did a Europe trip. Interestingly, most guests stayed in our two hotels were couples with resort having received more couples than city hotel. 

On a not so bright side, city hotels observed a 1.5 times higher in cancellation rate than resort. Most cancellations were common in that they steamed either from the bookings that were made too early in prior of the actual arrival date, or from bookings made by Groups and Travel agencies (both online and offline). We suspected that the loose cancellation policy of the OTA had promoted guests to abandon their bookings. Another counter - intuitive finding we discovered was that non - refund deposit group held the highest rate of cancellation; coupled with further looking into factors such as guests'special requests, we infered that customers who dropped out were either quite new to the hotels, had made a lot of cancellations before, rarely required parking space or rarely posed special requests yet still willing to pay in advance only to cancel later. 

Throughout this study, we had encountered a lot of questions which can both be answered and not. We started with some initial generic questions and actually ended up with more detailed questions and an unexpected turn where we did not expect in the beginning (the cancellation digging was a nice surprise). We also had to make a lot of assumptions to facilitate our analysis which in turns, enriched our knowledge base as we had to scan through a myriad of studies looking for the answers. Overall, we enjoyed our little challenge with this dataset and hope that anyone who reads this excersise could be inspired too.  


# Reference

