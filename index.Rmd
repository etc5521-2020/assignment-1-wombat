---
title: "ETC5521 Assignment 1"
subtitle: "Hotels and their Buinesss Managment"
team: WOMBAT
author:
  - Hai Hanh Ngo
  - Dewi Lestari Amaliah
  - Siyi Li
  - Priya Ravindra Dingorkar
date: "`r Sys.Date()`"
bibliography: references.bib
output: 
  bookdown::html_document2:
   toc: true
   toc_float: true
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

```{r library}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(gridExtra)
library(plotly) 
library(visdat)
library(countrycode)
library(DT)
library(maps)
library(viridis)
library(viridisLite)
library(naniar)
library(dplyr)
```

# Acknowledgements

Our sincere gratitude goes out for their guidance and encouragement to Professor Dianne Cook, Dr Emi Tanka, and the tutors Sayani Gupta and Sherry Zhang. Their culminating efforts have placed us in a position where we can generate this report collaboratively.

# Introduction and Motivation

Getting data from the hotel industry has always been a real challenge. Although we can read about hotel jargons and words easily, searched through some of the standard descriptive statistics of the hotel industry in market research reports on the internet for the price of your next summer holiday, lesser is known about how the hotel actually works behind the scenes. In this article let us have sneak into the hotel data in detail and come up with interesting findings.

The "hotel booking demand datasets" compiled by Nuno Antonio, Ana de Almeida and Luis Nunes [@AntonioNuno2019Hbdd] was a beautiful effort to overcome such challenge. This dataset was obtained from two hotels in Portugal - one city hotel in Lisbon and one resort in Algrave. Some of the sensitive information that could reveal the identity of the two hotels was not provided, but it did not affect the important role of this dataset for the purpose of education, management, machine learning and many others. Let us analyze and find out some intersting findings about the different workings of the hotels.

# Research Questions

## Primary Research Questions

Let us compare the efficiency of the two hotels, the City Hotel and the Resort Hotel, and try to understand the business of the hotels and what they really look like behind the scenes. Let us discuss how hotels manage the details of their clients, how bookings are priced, and how they are canceled bookings are managed.


## Secondary Research Questions 

- Which months across the two year, saw the most inflow of the tourist ?

- Let’s try to figure out the average daily rate of both types of hotels and figure out which type of hotel makes more money

- Exploring the Hotels’ Market Segment, Customers’s preference for Booking

- Which segment of the hotel market is more profitable and lets customers book their trip easily ?

- Where Did The Bookings Come From ?

- Let’s see, How do international guests like to reside in the hotels of Portugal ? How long do they they live there ?

- Lets us further find out if there any relationship, between the customer type and the ADR(Average Daily Rate) in the two different hotel types

- We, do not know, whether the meal type of the hotel data, can be inferred for the information of the length of stay of the guest. Let us try and find out if possible !! 

- In the generation of the added human intervention, cars play a huge role lets us find out whether there is any relationship between the the car parking space in the two different types of hotels mentioned in the dataset.

# Data description

## Dateset overview and structure

The datasets for the two hotels can be downloaded separately at [ScienceDirect.com](https://www.sciencedirect.com/science/article/pii/S2352340918315191) in the paper of @AntonioNuno2019Hbdd. However, @jthomasmock at _tidytuesday challenge_ had done us a favor and combined the two datasets into one. The two original datasets and the combined one can be obtained at this [GitHub page](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md). 

For this study, we used only the combined dataset which is stored in a _csv_ file format with 32 variables and 119,390 observations. Each observation represents one hotel booking. 

```{r load-data}
hotels <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv')
```

Knowing this dataset belonged to a hotel, we can make sense most of the variables. However, not all of them are familiar for anyone who did not have a background of hotel management. We will run through some of the industry jargons and variables'meaning before we take a further look at the data.

Variables note:  

*  is_cancelled: (1) if the booking was cancelled and (0) if not.  
*  lead_time: number of days between when the booking was entered into the hotel's booking system and the |arrival date.  
*  meal:  Type of meal booked which can be:  
   +  BB: Bed and Breakfast.  
   +  FB: Full board (breakfast, lunch and dinner).  
   +  HB: Half board (breakfast and one meal, usually dinner).  
   +  Undefined/ SC: no meal package.  
* country:  Guests'country of origin.  
* market_segment: guests'market segment, some of which may associate with booking channel.    
   +  Direct: guests that make bookings directly with the hotels, could be from hotel's website/ phone booking or walk-ins.  
   +  Corporate: Guests whom bookings are made by corporate/ company or guests who are business travellers.    
   +  Online TA: Online travel agents - bookings that made through a third party websites. Examples are Agoda, Expedia, Booking.com...  
   +  Offline TA/TO: Bookings made by Travel agents or Tour operators.  
   +  Complementary: Free stays offered for guests, usually from hotels' promotional programs.    
   +  Groups: guests who travelled in groups.  
   +  Undefined: Undefined type of guests.  
   +  Aviation: We are not entirely sure but this could be airline crews.    
* Distribution_channel:   
   +  Direct: bookings that made directly with the hotels (hotel's websites, phone or walk-ins)  
   +  Corporate:  bookings made by corporate/company.
   +  TA/TO: Travel agents/ tour operators/    
   +  Undefined: Undefined distribution channel.  
   +  GDS: Global Distribution System. GDS served like a hub for companies in the travel industry (airlines, hotels, car rental...) to connect with travel agents. Hotels will put some of their inventories (rooms) to the GDS and travel agents then can sell those rooms to their customers. Some of the well-known GDS include Amadeus, Sabre and Galileo.   
* is_repeated_guess: (1) if repeated and (0) if not.   
* customer_type:    
    + Transient: Individuals or groups that occupy less than 10 rooms per night. These guests usually stay in the hotel short - term and require little services.  
    + Contract: bookings bound by contracts, usually for more than 30 days for a consistent block of rooms.  
    + Transient - Party: Transient booking but associated to other transient booking.   
    + Group: bookings associated to a group, usually occupy more than 10 rooms per night.  
* previous_cancellations: number of previous cancellations prior to current booking by a customer.  
* previous_bookings_not_canceled: number of previous non - cancelled bookings prior to current booking by a customer.  
* booking_changes: number of changes made to the booking from when it was enterred into the system till the day of arrival/ cancellation.    
* agent: ID of travel agency that made the bookings.  
* company: ID of companies that made the bookings.  
* days_in_waiting_list: number of days booking was in the waiting list before it was confirmed to customers.  
* adr: Average Daily Rate, computed by taking total room revenue (excluded breakfast, tax and service charges) divided by total number of room nights sold.  

Kindly note that you may notice that some variables contained the "NULL" values (eg: agent or company variable). This "NULL" value did not mean the value was missing, rather such value did not exist to begin with; for example a booking may not have the ID of an agent or a company associated with it as such booking was made by an individual customer.  

## Limitation

* This dataset contained data for two specific hotels in Portugal. Such limitation in study objects introduced challenges when we attempted to explain the trends observed as reasons could be hotel- specific and we could not use industry knowledge to cover.  
* Some information of the hotels were not provided, for example the number of rooms, the occupancy rate, the location of the hotels (in the busy district or at the city suburban), years of operation or special events that might have occurred. The lack of information might render some of our questions unanswered.  
* Eventhough we were provided with the collection method, we were not be able to verify the validity and correctness of the data. We noticed during our analysis that some of the entries were not sensible and could very likely due to the input errors. However we were unable to verify such concern.  
* Since the observation began in July 2015 and ended in August 2017, we only have a fully cover data by year in 2016. Moreover, the coverage of the dataset in 2015 and 2017 are only six months and eight months, respectively. Hence, we would not analyze the data in year-wise manner because it might be not apple to apple to be compared. 

## Collection methods

@AntonioNuno2019Hbdd collected the data by extracting the variables from the hotels' PMS (Property Management System) databases' server with a TSQL query in SQL Server Studio Manager. The tables that were used to extract the variables are: 

1. BO (booking table in which the key, which is the ID, was retrieved).
2. BL (bookings change log, in this case, if the booking details with respect to the day before arrival changed, the value used was the one present in this table).
3. ML (meals).
4. DC (distribution channel).
5. TR (transaction).
6. CP (customer profiles).
7. NT (nationalities).
8. MS (market segments). 

A diagram below made by @AntonioNuno2019Hbdd presented the structure of the PMS databases: 

<center>

```{r pms-diagram, fig.cap = "PMS database diagrams"}
knitr::include_graphics(here::here("PMS_diagram.jpg"))
```
</center>

## Data Cleaning


### Missing values checking

@BennettDerrickA argued that it is important to take missing value into account, otherwise the statistical analysis will be misleading and variability of the data could not be estimated correctly. Thus, before analyzing the data, we checked the missing value using `visdat` package [@visdat] first. 

<center>

```{r missing-vals-check, cache = TRUE, fig.cap= "Variables Type and Missing Value Visualization"}
gg_miss_var(hotels) + ylab("Missing Values in Different Variables")
```

</center>


```{r children-missing, eval = FALSE}
children_missing <- naniar::where_na(hotels$children)
```

```{r imputing-ms}
average_children <- round(mean(hotels$children, na.rm = TRUE), 0)
imputed_children <- replace_na(hotels$children, average_children)
hotels <- cbind(hotels, imputed_children)
```

In `children` variable, when we found the missing value and we imputing it with the average of children (mean imputation) [@KangHyun2013Tpah] and created new variable called `imputed_children`.
We added this newly created column in the original dataset.

Figure \@ref(fig:missing-vals-check) shows that there is no missing value in the dataset otherwise. It is inline with what @AntonioNuno2019Hbdd stated that there is no missing values in the database table. However, we must take a note that some "NULL" values were presented which should be interpreted as "not applicable", not a missing value [@AntonioNuno2019Hbdd]. For example, if the the **company** value is NULL, it means that the booking was not made by a company.


### Data Transformation

The data is transformed to make it more structured. Properly structured and validated data boost data quality. Datatypes determine the visualisation, hence the correct datatypes, helps determine more accurate and better results. Keeping that in mind we have transformed the data type using `mutate` function from `tidyverse` @tidyverse and `as.factor` function from R built-in `base` package [@rcite]. Figure \@ref(fig:data-type) portrays that the variables have been in a correct type.


```{r}
hotels_corrected_type <- hotels %>%
  mutate(hotel = as.factor(hotel),
         is_canceled = as.factor(is_canceled),
         arrival_date_month = as.factor(arrival_date_month),
         arrival_date_year = as.factor(arrival_date_year),
         meal = as.factor(meal),
         country = as.factor(country),
         market_segment = as.factor(market_segment),
         distribution_channel = as.factor(distribution_channel),
         is_repeated_guest = as.factor(is_repeated_guest),
         reserved_room_type = as.factor(reserved_room_type),
         assigned_room_type = as.factor(assigned_room_type),
         deposit_type = as.factor(deposit_type),
         agent = as.factor(agent),
         company = as.factor(company),
         customer_type = as.factor(customer_type),
         reservation_status = as.factor(reservation_status))
```


<center>

```{r data-type, cache = TRUE, fig.cap= "Data Type Visualization"}
vis_dat(hotels_corrected_type, warn_large_data = FALSE)
```
</center>


We also created some variables by transforming or wrangling the original variable to analyze the data. Those variables are listed as follows:

1. `is_canceled_new`. This variable is actually the same with `is_canceled`. We only recoded the value from 0 and 1 to be "not canceled" and "canceled" in order to make it easier to interpret. 
2. `lengt_of_stay` is the number of days that the guests spend in the hotel. It is the summation of `stays_in_weekend_nights` and `stays_in_week_nights` variable.
3. `stay_on` is a categorical variable to observe whether the guests stayed in weekend, weekday, or both. 
4. `number_of_guest` is a summation of `adults`, `imputed_children`, and `babies` variables. 
5. `kids` is a summation of `imputed_children` and `babies` variables.
6. `family_type` is a categorical variable to observe whether the guest stayed with kids or not. 

The `lengt_of_stay` and `stay_on` would be used to analyze the staying pattern on the guests. Whilst `number_of_guest`, `kids`, and `family_type` would be used to analyze the type of guest who stayed at the hotel. Moreover, the dataset only provides the country of bookings with country codes coded in ISO code. Hence, we transform these code to the country name using `countrycode` package [@countrycode]. 


```{r}
hotels_new_data <- hotels_corrected_type %>%
  mutate(is_canceled_new = if_else(
           condition = is_canceled == 0,
           true = "not canceled",
           false = "canceled"),
         length_of_stay = stays_in_weekend_nights + stays_in_week_nights,
         stay_on = ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights != 0, "Weekday and Weekend",
                          ifelse(stays_in_weekend_nights != 0 & stays_in_week_nights == 0, "Weekend", "Weekday")),
         number_of_guest = adults + imputed_children + babies,
         kids = imputed_children + babies,
         family_type = ifelse(kids != 0, "family", "not family"),
         arrival_month_year = paste0(arrival_date_month, arrival_date_year),
         semester = case_when(str_detect(arrival_month_year, "July2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "August2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "September2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "October2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "November2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "December2015") ~ "2015 Sem 2",
                              str_detect(arrival_month_year, "January2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "February2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "March2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "April2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "May2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "June2016") ~ "2016 Sem 1",
                              str_detect(arrival_month_year, "July2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "August2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "September2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "October2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "November2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "December2016") ~ "2016 Sem 2",
                              str_detect(arrival_month_year, "January2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "February2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "March2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "April2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "May2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "June2017") ~ "2017 Sem 1",
                              str_detect(arrival_month_year, "July2017") ~ "2017 Sem 2",
                              str_detect(arrival_month_year, "August2017") ~ "2017 Sem 2"))
```

# Analysis and Findings

**Tourism and Seasonality in Portugal**

The tourism industry worries a lot about seasonality, as it will affect the flow of visitors to tourist destinations. The hotel season is divided into two main seasons: high and low seasons. As the name suggests, high season is a busy season when the weather is good and the guests' inflows are high; low season vice versa.

Portugal is no exception to this. The high season in Portugal usually runs in summer (June to September) and in spring (January to March); the beaches are usually the busiest in July and August. The low season generally occurs during the winter season, which begins around November and ends at the end of February. Weather during this time can display rainfall, unexpected rain and a strong, cold breeze which is not too ideal for sightseeing [@lisbon]. 

Keeping the season in mind, we are interested in finding out any potential effect of seasonality on the guest count and the ADR of our hotels in the report.

```{r var-choose}
hotel_mngt <- hotels %>%
  mutate(arrival_date = dmy(paste0(arrival_date_day_of_month, arrival_date_month, arrival_date_year, sep = "-"))) %>%
  select(hotel, arrival_date, arrival_date_week_number,arrival_date_month, arrival_date_year, lead_time,
         previous_cancellations, previous_bookings_not_canceled, deposit_type, booking_changes,deposit_type,
         agent, days_in_waiting_list, required_car_parking_spaces, total_of_special_requests, 
         reservation_status, reservation_status_date, customer_type, market_segment, adr, is_repeated_guest, adults, children, babies) %>%
  # Tweaking a bit
  mutate(hotel = as.factor(hotel),
         year = as.numeric(arrival_date-arrival_date[1]) %/% 365+1)
```

## Which months across the two year, saw the most inflow of the tourist ?

The inflow of visitors to these two hotels will help us decide the months in Portugal are the best time to travel to Portugal, and which hotel is the place to stay when you travel to Portugal.

```{r season}
season <- hotel_mngt %>%
  select(hotel, arrival_date_month, year,reservation_status, customer_type, market_segment, adr, adults, children, babies) %>%
  # Choose successful bookings only to avoid distortion of adr
  filter(reservation_status == "Check-Out",
  # filter out bookings with ADR < 0 - there are bookings with negative adr!
         market_segment >= 0) %>%
  # convert month to factor for plotting purpose
  mutate(arrival_date_month = as.factor(arrival_date_month),
         total_guests = adults + children + babies)
```

<center>
```{r guest-by-month, fig.cap = "Count of Number of Guests by each month in the two Different Years"}
# Guests count by month
season %>%
  group_by(hotel, year, arrival_date_month) %>%
  summarise(total_guests = sum(total_guests)) %>%
  # Year 3 does not have full years (3 months only) so we used year 1 and 2
  filter(!year == 3) %>%
  # Grouping will make geom_line runs in a straight vertical line
  ungroup() %>%
  ggplot(aes(x = factor(arrival_date_month, levels = c("July", "August", "September", "October", "November", "December", "January", "February", "March", "April", "May", "June")), y = total_guests,
             group=factor(year), colour=factor(year))) +
  geom_line() +
  theme_classic() +
  facet_wrap(~hotel) +
  labs(title = "Count of Guests by each Month",
       x = "Months",
       y = "Count of the total Guest",
       colour = "Year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c("#000080", "#FF0000"))
```
</center>

Months are described in the order of occurrence (July was the first year of each year) to maintain the chronological order of the dataset. The overall pattern has been nearly the same for both hotels and years. The seasonality pattern was similar to the "W" shape, with the lower points of W occurring in the winter months from November to January, and the high points in the spring and summer periods. Interestingly, both hotels had the highest number of guests in the spring season in Year 1 (May and March) while in Year 2, the highest tourism was recorded in the summer season (August and October).

We can therefore infer that most of the months are a good time to visit Protugal, particularly from July to October and January to March, the graph above shows that most of the guests prefer to stay in City Hotel compared to the Resort Hotel.

## Let's try to figure out the average daily rate of both types of hotels and figure out which type of hotel makes more money

The average daily rate (ADR) calculates the average rental income received in an occupied room per day. The operating performance of a hotel or other lodging company can be calculated by using the ADR.

<center>
```{r ADR-by-month, fig.cap = "Average Daily Rate Versus Hotel Type"}
# ADR by months
adr <- season %>%
  group_by(hotel, year, arrival_date_month) %>%
  # Year 3 does not have full years (3 months only) so we used year 1 and 2
  filter(!year == 3) %>%
  summarise(avg_adr = mean(adr)) %>%
  # Grouping will make geom_line runs in a straight vertical line
  ungroup() %>%
  ggplot(aes(x = factor(arrival_date_month, levels = c("July", "August", "September", "October", "November", "December", "January", "February", "March", "April", "May", "June")), y = avg_adr,
             group=factor(year), colour=factor(year))) +
  geom_line() +
  geom_point(shape=21, color="black", fill="#69b3a2", size=3) +
  theme_classic() +
  facet_wrap(~hotel) +
  labs(title = "Average Daily Rate for each Month",
       x = "Month",
       y = "Currency",
       colour = "Year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c("#000080", "#FF0000"))
adr
```
</centre>

Figure \@ref(fig:ADR-by-month) indicates a substantial gap between the two hotels. The resort had the highest summer time prices, which makes sense because Algrave is a beach town. Both hotels reported the lowest winter prices, but less fluctuation was observed by City hotel than by Resort hotel.

## Exploring the Hotels' Market Segment, Customers's preference for Booking in the two hotel types

According to @meier, one key to being effective in hotel management is a specific market segment, particularly to set the price correctly. It is therefore important to identify the market segment distribution for these hotels.

A study from [Phocuswright](https://www.pegs.com/blog/why-do-travelers-prefer-booking-with-otas/) in @pegs stated that one of the major reason of why do the people book trough OTA is beacuse the website is easy to use. Meanwhilst, @howe argued that OTAs are favorable because its easy booking option. According to @jedina2017exploring in @TalwarShalini2020Wdpp, the factors for booking the hotel through OTA are the accessibility, pricing, review accountability, and the customer services. 
Let us try to find out, whether this holds true for the Portugal hotels

<center>
```{r market-segment, fig.cap = "The distribution of hotel market segment in the city and resort hotel (2015-2017)"}

ms_change <- hotels_new_data %>% 
  dplyr::filter(market_segment %in% c("Online TA", "Offline TA/TO" ,
                  "Groups" , "Direct" , "Corporate"))%>% 
  dplyr::mutate(market_segment = factor(market_segment, levels = c("Direct", "Corporate" , "Online TA", "Offline TA/TO" , "Groups"))) %>% 
  ggplot() +
  geom_bar(aes(x = market_segment, 
            fill = hotel), 
           position = "fill", color = "black") +
  xlab("Hotel Type") +
  ylab("Proportion") +
  theme(text = element_text(size = 8)) +
  coord_flip() +
  theme_classic()
ms_change
```
</center>

Figure \@ref(fig:market-segment) shows that the vast majority of Online Travel Agency (OTA). We can clearly distinguish that, customers generally, make their bookings through online or offline agency and groups for City Hotel bookings. On the other hand, we witness that most customer make their resort hotel bookings through corporate or direct booking made by the customers. Moreover, in the city hotel the portion of bookings via OTA was greater than in the resort hotel. Unlike the city hotel, in the resort hotel we could see more portion of individual reservations than party bookings. This proves the study from Phocuswright, and hence people like to ease in booking their trips, hence they use the agency bookings.

## Which segment of the hotel market is more profitable and lets customers book their trip easily ?

Study of which is the best way to book your ticket would allow customers to select their services when booking trips to the hotel

<center> 
```{r semester-ms-plot, fig.cap = "The distribution of hotel market segment in the city and resort hotel by semester" }

semester_ms_plot <- ggplot(filter(hotels_new_data, semester != "2017 Sem 2")) +
  geom_bar(aes(y = semester, 
               fill = market_segment), 
           position = "dodge" , color = "black") +
  xlab("Proportion") +
  ylab("Semester Wise Duration") +
  theme(text = element_text(size = 8)) +
  facet_wrap(~hotel) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

semester_ms_plot
```
</center>

OTA has been the major player in the business segment of these hotels, it only took over the supremacy of group reservations in the city hotel in a half year period. In the first semester of 2016, the proportion of the OTA was doubled than in the previous semester.

The bookings through OTA have dominated since the beginning of the time observed, while at the resort hotel in comparison to the city hotel, the bookings via OTA marginally decreased in the first semester of 2016 and the group bookings increased or customers started booking on their own. We could also see that both hotels had hit the peak in the proportion of OTA bookings in semester 2 of 2016.

Aside from OTA matter, Figure \@ref(fig:semester-ms-plot) shows another interesting fact that in the condition of OTA booking was dominating the market segment, the proportion of direct booking in the resort hotel was relatively stable, this could be the reason may be cause this resort has their own way to promote their direct booking, for example may be through a loyalty voucher

## Where Did The Bookings Come From ? 

Another way to obtain more business information is to look at the roots of the travellers who book hotel space. An understanding of their actions and preference is essential. Therefore the hoteliers will establish strategies for attracting them.

We may examine which part of the world is most drawn to Portuguese


```{r country-check}

# check if there is undefined country in the hotel bookings

#dplyr::distinct(hotels_new_data, country)

# Apparently, there is also a null observation in the country name. 
# We would like to know the percentage of this null country observation.

null_country <- hotels_new_data %>% filter(country == "NULL")
p_null_country <- round(nrow(null_country)/ nrow(hotels_new_data) * 100, 3)


```

```{r bookers-table}

book_origin <- hotels_new_data %>% filter(country != "NULL") %>% 
  group_by(country) %>%
  count(country) %>%
  arrange(desc(n)) %>%
  ungroup

# The country comes in ISO3 name, in order to get better interpretation, we recode the country to its actual name

country_name <- countrycode(book_origin$country, "iso3c", "country.name")

book_origin_new <- cbind(book_origin, country_name)

#countrycode function could not find the match of "CN" and "TMP", so we changed it manually

book_origin_new[13,3] = "CN"
book_origin_new[130,3] = "East Timor"

col_order <- c("country", "country_name", "n")

book_origin_table <-  book_origin_new[, col_order]
```

<center>
```{r bookings-map, fig.cap = "The distibution of travelers origin who books the hotels in 2015-2017"}

world_map <- map_data("world")
bookings_map_dat <- left_join(book_origin_table, world_map, by = c("country_name" = "region"))

bookings_map <- ggplot(bookings_map_dat, aes(long, lat, group = group))+
  geom_polygon(aes(fill = n ), color = "white") +
  scale_fill_viridis("C")+
  theme_bw()

ggplotly(bookings_map)

```
</center>

Figure \@ref(fig:bookings-map) provides a booking map of the country of origin to get a view of the booking distribution, throughout the globe, The hover options, helps us with the count of the guests who have visited Portugal. If you hover over the map, it tell us that Portugal sees more tourists from Europe than the rest of the continents

As this could be a topic of interest for most of you and each individual, may want to know the count of guests that have visited Portugal. The interactive table below, allows you to get a detail view. The table suggests that the bookings came from `r nrow(book_origin_table)` different countries.

<center>
```{r origin_table}
DT::datatable(book_origin_table, colnames = c("Country Code", "Country Name", "Number of Bookings"),
              caption = "The number of hotel bookings based on bookings country of origin")
```
</center>

## Let's see the effect of ADR on the two types of hotels with different types of guests.

```{r mutate-origin}

# Create new variable which categorize the origin of travelers.
# We omitted the country observations that are equal to NULL

origin_cat <- hotels_new_data %>%
  filter(country != "NULL") %>%
  mutate(origin = if_else(
           condition = country == "PRT",
           true = "local",
           false = "international"))

```

Let's try to find descriptive statistics on how the average daily rate impacts the various categories of guests in the hotel, respectively. Have the foreign guests been helping to increase the hotel profit. Lets us find out.

<center>
```{r adr-origin-boxplot, fig.cap="Distribution of ADR by guest origin in the city and resort hotel"}

adr_origin <- filter(origin_cat, is_canceled == 0)

adr_origin_boxplot <- ggplot(adr_origin) +
  geom_boxplot(aes(x = origin,
               y = adr, fill = origin)) +
  xlab("Guests Origin") +
  ylab("ADR (Euro)") +
  facet_wrap(~ hotel) +
  theme(text = element_text(size = 8)) +
  scale_fill_manual(values = c("#F1C40F", "#5DADE2"))+
  theme_classic()

ggplotly(adr_origin_boxplot)
```
</center>

We have analysed that most bookings in both hotels are from international travelers and the ADR median presented in Figure \@ref(fig:adr-origin-boxplot) Shows that foreign guests in both types of hotels paid more money than the locals. Therefore we might argue that these travelers have become the hotels' valued customers. The hover option, gives us more detail in the summary statistics and we can infer which 25 percentile/75 percentile values of ADR in Euros. This will be a good insight for us, when we have a certain limit on the expenditure for trips can keep this percentiles as reference and evaluate our desired expenditure

Since the international travellers have become the hotel's valued guest, it is easier to retain them through personalization as a potential long-term customer. According to @criton personalization is the secret to the customer's heart winning.

## Let's see, How do international guests like to reside in the hotels of Portugal ? How long do they they live there ?

With regard to the behavior that the guest could conduct, we would like to figure it out by looking at the time that the guest stayed in which hotels. Lets us find out which hotel was preferred for a longer stay.

<center>
```{r when-stay-plot, fig.cap= "The distribution of time the guest stayed at the hotels", out.width="50%"}

when_stay_plot <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0)) +
  geom_bar(aes(y = hotel,
               fill = stay_on),
           position = "dodge", 
           color = "black") +
  xlab("Proportion of Days Stayed") +
  ylab("Hotel Type") +
  theme(text = element_text(size = 8)) +
  theme_classic()
  

when_stay_plot
```
</center>

Seems like  there in the Portugal a lot to explore, from our analysis we note that most international guests want to stay for a longer period of time. We infer from figure \@ref(fig:when-stay-plot) that, most tourist that travel to Portugal, like to stay for a longer period of time that is more than the weekend. Lets us try and understand, which hotel do the tourist like to stay in for their stay and does number of days of stay, give us insight on the the preference of the hotel.

<center>
```{r length-of-stay-hist-city, fig.cap= "Length of stay of international guest in the city hotel", out.width= "1000%"}

city_long_stay <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "City Hotel")) +
  geom_histogram(aes(x = length_of_stay, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "black",
                 fill = "#F1948A",
                 show.legend = FALSE) +
  #scale_x_continuous(breaks = seq(0, 60, by=5)) +
  xlab("Length of Stay at City Hotel") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent)+
  theme_classic() + xlim(0,9)

resort_long_stay <- ggplot(filter(origin_cat, is_canceled == 0 & origin == "international" & length_of_stay !=0 & hotel == "Resort Hotel")) +
  geom_histogram(aes(x = length_of_stay, 
                     y = stat(count)/sum(stat(count))),
                 binwidth = 1, 
                 colour = "black",
                 fill = "#3ED9DE",
                 show.legend = FALSE) +
  #scale_x_continuous(breaks = seq(0, 60, by=5)) +  
  xlab("Length of Stay at Resort Hotel") +
  ylab("Percent of Bookings") +
  theme(text = element_text(size = 8)) +
  scale_y_continuous(labels = scales::percent) +
  theme_classic() + xlim(0,9)

gridExtra::grid.arrange(city_long_stay, resort_long_stay)
```

Figure \@ref(fig:length-of-stay-hist-city) helps us infer that if the stay is longer than the weekend and extends one or two day, than we see that the percent of bookings is greater in the city hotel. But on closer look, we understand that if the traveller stays for a longer time that is week and above, we might infer that, that the tourist would live in the resort hotel.

## Lets us further find out if there any relationship, between the customer type and the ADR(Average Daily Rate) in the two different hotel types

During the analysis of this question, we will find out which customer types contribute the most towards which hotel type. Before we move towards our analysis we need to understand the type of these customers:
- Transient: Individuals or groups that occupy less than 10 rooms per night. These guests usually stay in the hotel short - term and require little services.  
- Contract: bookings bound by contracts, usually for more than 30 days for a consistent block of rooms. 
- Transient - Party: Transient booking but associated to other transient booking.   
- Group: bookings associated to a group, usually occupy more than 10 rooms per night.

<center>
```{r adr-cust, fig.cap="Relationship, between the customer type and the ADR(Average Daily Rate"}
cust_hotel_data <- hotels_new_data%>%
  select(hotel,adr,customer_type)

cust_hotel_data%>%
  ggplot(aes(x = hotel, y=adr, color = hotel, fill = hotel))+
  geom_col()+
  facet_wrap(~customer_type)+
  ylim(0,600) +
  xlab("Type of Hotels") +
  ylab("Contibution towrads ADR in different customers") +
  theme(text = element_text(size = 8))+
  theme_classic()
```
</center>

In the figure \@ref(fig:adr-cust), we can infer that Individuals or groups that occupy less than 10 rooms per night can also be called as Transient customer, contribute more towards the City Hotel in terms of the ADR. Customers bound by contract, also contribute a slight more towards City hotel as compared to the resort hotel. But when we have bookings associated to a group, usually occupying more than 10 rooms per night, this type of customers will mostly choose to reside at the resort hotel and contribute towards it's ADR. This finding also aligns with the previous research question about the length of stay. So we can infer that, when temporary customers or contract based customers visit Portugual, they will be mostly be residing at the City Hotel, thus contributing to the profits of the ADR in that particular hotel.

## Whether the meal type of the hotel data, can be inferred for the information of the length of stay of the guest. 

Let us try and infer the relationship between the meal type the customers has choosen versus the length of stay of that customer.

<center>
```{r meal-stay, fig.cap="Relationship between Meals and Length of Stay"}
library(hrbrthemes)
library(viridis)
meal_hotel_data <- hotels_new_data %>%
  select(hotel,meal, length_of_stay) %>% 
  filter(meal %in% c("BB", "FB", "HB")) %>% 
  dplyr::mutate(meal_name = case_when(str_detect(meal, "BB") ~ "Breakfast",
                                      str_detect(meal, "HB") ~ "Breakfast and One Meal",
                                      str_detect(meal, "FB") ~ "Breakfast, Lunch and Dinner"))

ggplot(meal_hotel_data, aes(x = length_of_stay, group = meal_name, fill= meal_name)) +
    geom_density(adjust=1.5, alpha = 0.6) +
    theme_ipsum() +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    facet_wrap(~hotel) +
    theme(
      legend.position="right",
      panel.spacing = unit(0.1, "lines"),
      axis.ticks.x=element_blank()) +
  xlim(0,9) + xlab("Length of Stay") +ylab("") 
```
</center>

Figure \@ref(fig:meal-stay), helps us determine the relationship between, the length of stay of the different customers in the two different types of the hotel based upon the meal type. Lets us first look in to the City Hotel, we infer that, if the length of stay is around just for a day or so, then the customer choose to have only the breakfast. If the customer books a trip for more than five days he is mostly likely to choose a full board meal, else the customers choose a half board meal. Whereas, if the see the scenario, in the Resort Hotel, we infer that most customers here choose the full board or half board meal, as we have witness that the customers in the  resort hotel generally reside longer than three days.

## Whether there is any relationship between the the car parking space in the two different types of hotels mentioned in the dataset.

<center>
```{r}
library(hrbrthemes)
parking_data <-origin_cat %>% dplyr::select(hotel, required_car_parking_spaces, origin,length_of_stay, customer_type, family_type)

family_car_parking <- parking_data %>%
group_by(origin)%>% 
  count(required_car_parking_spaces) %>%
  mutate(count_number_of_car_parking_space=n) %>%
  ggplot(aes(x=required_car_parking_spaces, 
             y=count_number_of_car_parking_space,
             col=origin))+
  geom_line()+
  xlab("Required Car Parking Space")+
  ylab("Count of Guest")

ggplotly(family_car_parking)

```
</center

According to the graph of the required number of car parking spaces against guest type, majority of the people whether the international or local do not need a car parking space, but there is a small percentage of people need one car parking space(4200 times belong to international guests, 3077 belong to local guest).

<center>
```{r}
family_car_parking<-parking_data%>%
group_by(family_type)%>% 
  count(required_car_parking_spaces)%>%
  mutate(count_number_of_car_parking_space=n)%>%
  ggplot(aes(x=required_car_parking_spaces, y=count_number_of_car_parking_space,col=family_type))+
           geom_line()+
  xlab("required number of car parking spaces")+
  ylab(" number of people")
ggplotly(family_car_parking)
```
</center>

According to the graph of the required number of car parking spaces against family type, majority of the people whether the family or not family do not need a car parking space, but there is a small percentage of people need one car parking space(1850 times belong to family, 6288 belong to not family).


<center>
```{r}
hotel_car_parking<-parking_data%>%
group_by(hotel)%>% 
  count(required_car_parking_spaces)%>%
  mutate(count_number_of_car_parking_space=n)%>%
  ggplot(aes(x=required_car_parking_spaces, y=count_number_of_car_parking_space,col=hotel))+
           geom_line()+
  xlab("required number of car parking spaces")+
  ylab(" number of people")
ggplotly(hotel_car_parking)
```
</center>


According to the graph of the required number of car parking spaces against hotel type, majority of the people whether the family or not family do not need a car parking space, but there is a small percentage of people need one car parking space(6402 times belong to transient, 133 belong to contract,797 belong to transient-party and 51 belong to group).



<center>
```{r}
customer_car_parking<-parking_data%>%
group_by(customer_type)%>% 
  count(required_car_parking_spaces)%>%
  mutate(count_number_of_car_parking_space=n)%>%
  ggplot(aes(x=required_car_parking_spaces, y=count_number_of_car_parking_space, col=customer_type))+
           geom_line()+
  xlab("required number of car parking spaces")+
  ylab(" number of people")
ggplotly(customer_car_parking)
```
</center>

According to the graph of the required number of car parking spaces against customer type, majority of the people whether the family or not family do not need a car parking space, but there is a small percentage of people need one car parking space(1921 times belong to city hotel, 5462 belong to resort hotel). It indicates that people who live in resort hotel prefer a car parking space, and i think that they may have a holiday here. There is an interesting thing, and resort hotel is asked twice by visitors with 8 car parking spaces. all the visitors are not family. it is pretty superise since these people are transient-party rather than Group.


























